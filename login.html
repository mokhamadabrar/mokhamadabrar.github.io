<!DOCTYPE html>
<html lang="id">
	<head>
		<meta charset="UTF-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1.0" />
		<title>Login | Form Observasi Keselamatan</title>
		<link rel="preconnect" href="https://fonts.googleapis.com" />
		<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
		<link
			href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap"
			rel="stylesheet"
		/>
		<style>
			body {
				font-family: "Inter", -apple-system, BlinkMacSystemFont, "Segoe UI",
					Roboto, Helvetica, Arial, sans-serif;
				background-color: #f4f7f6;
				background-image: linear-gradient(to bottom right, #f8f9fa, #e9ecef);
				margin: 0;
				padding: 20px;
				color: #333;
				display: flex;
				justify-content: center;
				align-items: center;
				min-height: 100vh;
			}
			.container {
				max-width: 400px;
				width: 100%;
				margin: 20px auto;
				background-color: #ffffff;
				padding: 40px;
				border-radius: 12px;
				box-shadow: 0 8px 24px rgba(0, 0, 0, 0.08);
				position: relative;
			}
			.language-buttons {
				position: absolute;
				top: 15px;
				right: 15px;
				display: flex;
				gap: 10px;
			}
			.language-button {
				cursor: pointer;
				width: 28px;
				height: 28px;
				border-radius: 50%;
				overflow: hidden;
				box-shadow: 0 1px 4px rgba(0, 0, 0, 0.2);
				transition: transform 0.2s ease, box-shadow 0.2s ease;
				border: 2px solid transparent;
			}
			.language-button:hover {
				transform: scale(1.1);
			}
			.language-button.active {
				border-color: #007bff;
			}
			.language-button img {
				width: 100%;
				height: 100%;
				object-fit: cover;
			}
			h1 {
				text-align: center;
				color: #2c3e50;
				margin-bottom: 25px;
				font-size: 24px;
				font-weight: 700;
			}
			.form-group {
				margin-bottom: 15px;
			}
			label {
				display: block;
				font-weight: 600;
				margin-bottom: 6px;
				font-size: 14px;
			}
			input[type="text"],
			input[type="password"],
			input[type="email"] {
				width: 100%;
				padding: 10px 12px;
				border: 1px solid #dfe6e9;
				border-radius: 6px;
				box-sizing: border-box;
				font-size: 15px;
				background-color: #fdfdfd;
				transition: border-color 0.3s ease, box-shadow 0.3s ease;
			}
			input[type="text"]:focus,
			input[type="password"]:focus,
			input[type="email"]:focus {
				border-color: #007bff;
				box-shadow: 0 0 0 3px rgba(0, 123, 255, 0.15);
				outline: none;
			}
			.submit-btn {
				display: block;
				width: 100%;
				padding: 12px 15px;
				background-image: linear-gradient(to right, #007bff, #0056b3);
				background-color: #007bff;
				color: white;
				border: none;
				border-radius: 6px;
				font-size: 16px;
				font-weight: bold;
				cursor: pointer;
				transition: all 0.3s ease;
				box-shadow: 0 4px 10px rgba(0, 123, 255, 0.3);
			}
			.submit-btn:hover {
				background-image: linear-gradient(to right, #0056b3, #007bff);
				transform: translateY(-2px);
				box-shadow: 0 6px 12px rgba(0, 123, 255, 0.4);
			}
			.message {
				text-align: center;
				font-weight: bold;
				padding: 10px;
				border-radius: 5px;
				margin-bottom: 15px;
				display: none;
			}
			.message.error {
				background-color: #f8d7da;
				color: #721c24;
				border: 1px solid #f5c6cb;
				display: block;
			}
			.switch-form {
				text-align: center;
				margin-top: 20px;
				font-size: 14px;
			}
			.switch-form a {
				color: #007bff;
				text-decoration: none;
				font-weight: 600;
			}
		</style>
	</head>
	<body>
		<div class="container">
			<div class="language-buttons">
				<div class="language-button" id="lang-id" data-lang="id">
					<img src="img/ID.svg" alt="Bahasa Indonesia" />
				</div>
				<div class="language-button active" id="lang-en" data-lang="en">
					<img src="img/EN.svg" alt="English" />
				</div>
			</div>
			<form id="loginForm">
				<h1 data-key="loginTitle">Login</h1>
				<div id="message" class="message"></div>
				<div class="form-group">
					<label for="email" data-key="emailLabel">Email</label>
					<input type="email" id="email" name="email" required />
				</div>
				<div class="form-group">
					<label for="password" data-key="passwordLabel">Password</label>
					<input type="password" id="password" name="password" required />
					<div style="text-align: right; margin-top: 5px">
						<a
							href="#"
							id="showResetForm"
							data-key="forgotPassword"
							style="font-size: 12px; color: #007bff; text-decoration: none"
							>Forgot Password?</a
						>
					</div>
				</div>
				<button type="submit" class="submit-btn" data-key="loginButton">
					Login
				</button>
			</form>

			<form id="resetForm" style="display: none">
				<h1 data-key="resetPasswordTitle">Reset Password</h1>
				<div id="resetMessage" class="message"></div>
				<p
					data-key="resetPasswordDesc"
					style="
						margin-bottom: 15px;
						font-size: 14px;
						color: #666;
						text-align: center;
					"
				>
					Enter your email to receive a password reset link.
				</p>
				<div class="form-group">
					<label for="resetEmail" data-key="emailLabel">Email</label>
					<input type="email" id="resetEmail" name="resetEmail" required />
				</div>
				<button type="submit" class="submit-btn" data-key="sendResetLink">
					Send Reset Link
				</button>
				<div style="text-align: center; margin-top: 15px">
					<a
						href="#"
						id="backToLogin"
						data-key="backToLogin"
						style="font-size: 14px; color: #007bff; text-decoration: none"
						>Back to Login</a
					>
				</div>
			</form>
			<div class="switch-form">
				<p>
					<span data-key="loginAs">Login as</span>
					<a href="admin-login.html" data-key="adminLink">Admin</a>
				</p>
				<p>
					<span data-key="noAccount">Don't have an account?</span>
					<a href="register.html" data-key="registerLink">Register here</a>
				</p>
			</div>
		</div>

		<!-- Firebase Scripts -->
		<!-- These scripts are now served by Firebase Hosting -->
		<script src="/__/firebase/8.6.1/firebase-app.js"></script>
		<script src="/__/firebase/8.6.1/firebase-auth.js"></script>
		<script src="/__/firebase/8.6.1/firebase-firestore.js"></script>
		<script src="/__/firebase/8.6.1/firebase-storage.js"></script>
		<script src="/__/firebase/init.js"></script>
		<script src="js/firebase-init.js"></script>

		<script>
			document.addEventListener("DOMContentLoaded", function () {
				const translations = {
					id: {
						loginTitle: "Masuk",
						emailLabel: "Email",
						passwordLabel: "Kata Sandi",
						loginButton: "Masuk",
						loginAs: "Masuk sebagai",
						adminLink: "Admin",
						noAccount: "Belum punya akun?",
						registerLink: "Daftar di sini",
						errorGeneric: "Terjadi kesalahan. Silakan coba lagi.",
						loginError:
							"Email atau kata sandi tidak sesuai, atau akun Anda belum disetujui oleh admin.",
						errorEmailNotVerified:
							"Email Anda belum diverifikasi. Silakan periksa kotak masuk Anda.",
						errorPendingApproval: "Akun Anda menunggu persetujuan admin.",
						errorInvalidRole:
							"Akun Anda memiliki peran yang tidak valid. Silakan hubungi dukungan.",
						errorNotRegistered:
							"Pengguna tidak ditemukan. Silakan daftar atau hubungi dukungan.",
						forgotPassword: "Lupa Password?",
						resetPasswordTitle: "Atur Ulang Password",
						resetPasswordDesc:
							"Masukkan email Anda untuk menerima tautan atur ulang password.",
						sendResetLink: "Kirim Tautan",
						backToLogin: "Kembali ke Masuk",
						resetPasswordSuccess:
							"Tautan atur ulang password telah dikirim ke email Anda. Cek email Anda (termasuk folder Spam) untuk verifikasi.",
						resetPasswordError:
							"Gagal mengirim tautan atur ulang password. Silakan periksa email Anda.",
					},
					en: {
						loginTitle: "Login",
						emailLabel: "Email",
						passwordLabel: "Password",
						loginButton: "Login",
						loginAs: "Login as",
						adminLink: "Admin",
						noAccount: "Don't have an account?",
						registerLink: "Register here",
						errorGeneric: "An error occurred. Please try again.",
						loginError:
							"Email or password is incorrect, or your account has not been approved by an admin.",
						errorEmailNotVerified:
							"Your email address is not verified. Please check your inbox.",
						errorPendingApproval: "Your account is pending admin approval.",
						errorInvalidRole:
							"Your account has an invalid role. Please contact support.",
						errorNotRegistered:
							"User not found. Please register or contact support.",
						forgotPassword: "Forgot Password?",
						resetPasswordTitle: "Reset Password",
						resetPasswordDesc:
							"Enter your email to receive a password reset link.",
						sendResetLink: "Send Reset Link",
						backToLogin: "Back to Login",
						resetPasswordSuccess:
							"Password reset link sent to your email. Check your email (including Spam folder) for verification.",
						resetPasswordError:
							"Failed to send password reset link. Please check your email.",
					},
				};

				let currentLang = "en";
				const langButtons = document.querySelectorAll(".language-button");

				function applyTranslation(lang) {
					document.querySelectorAll("[data-key]").forEach((element) => {
						const key = element.getAttribute("data-key");
						if (translations[lang][key]) {
							element.textContent = translations[lang][key];
						}
					});
					document.title =
						lang === "id"
							? "Masuk | Form Observasi Keselamatan"
							: "Login | Safety Observation Form";
					currentLang = lang;
					langButtons.forEach((button) => {
						button.classList.remove("active");
						if (button.dataset.lang === lang) {
							button.classList.add("active");
						}
					});
				}

				langButtons.forEach((button) => {
					button.addEventListener("click", function () {
						applyTranslation(this.dataset.lang);
					});
				});

				applyTranslation(currentLang); // Apply default language on load

				let currentUser = null; // Declare currentUser in a broader scope

				document
					.getElementById("loginForm")
					.addEventListener("submit", function (event) {
						event.preventDefault();

						const email = document.getElementById("email").value;
						const password = document.getElementById("password").value;
						const messageDiv = document.getElementById("message");
						messageDiv.style.display = "none";

						firebase
							.auth()
							.signInWithEmailAndPassword(email, password)
							.then((userCredential) => {
								currentUser = userCredential.user; // Assign to broader scope currentUser
								return db.collection("users").doc(currentUser.uid).get();
							})
							.then((doc) => {
								if (doc.exists) {
									const userData = doc.data();

									if (userData.role === "admin") {
										// Admins bypass email verification
										sessionStorage.setItem(
											"adminUser",
											JSON.stringify({
												email: currentUser.email,
												displayName: currentUser.displayName,
												uid: currentUser.uid,
											})
										);
										sessionStorage.setItem(
											"loggedInUser",
											JSON.stringify({
												email: currentUser.email,
												displayName: currentUser.displayName,
												uid: currentUser.uid,
											})
										);
										window.location.href = "index.html";
									} else if (userData.role === "user") {
										// For regular users, enforce email verification and approval
										if (!currentUser.emailVerified) {
											throw new Error("auth/email-not-verified");
										}
										if (userData.status === "approved") {
											sessionStorage.setItem(
												"loggedInUser",
												JSON.stringify({
													email: currentUser.email,
													displayName: currentUser.displayName,
													uid: currentUser.uid,
												})
											);
											window.location.href = "index.html";
										} else {
											throw new Error("auth/pending-approval");
										}
									} else {
										throw new Error("auth/invalid-role");
									}
								} else {
									throw new Error("auth/not-registered");
								}
							})
							.catch((error) => {
								let errorMessage = translations[currentLang].loginError; // Default generic error
								switch (error.code) {
									case "auth/email-not-verified":
										errorMessage =
											translations[currentLang].errorEmailNotVerified ||
											"Please verify your email address.";
										break;
									case "auth/pending-approval":
										errorMessage =
											translations[currentLang].errorPendingApproval ||
											"Your account is pending admin approval.";
										break;
									case "auth/invalid-role":
										errorMessage =
											translations[currentLang].errorInvalidRole ||
											"Your account has an invalid role. Please contact support.";
										break;
									case "auth/not-registered":
										errorMessage =
											translations[currentLang].errorNotRegistered ||
											"User not found. Please register or contact support.";
										break;
									case "auth/user-not-found":
									case "auth/wrong-password":
										errorMessage = translations[currentLang].loginError; // Generic for incorrect credentials
										break;
									default:
										errorMessage = translations[currentLang].errorGeneric;
										break;
								}
								messageDiv.textContent = errorMessage;
								messageDiv.className = "message error";
								messageDiv.style.display = "block";
								firebase.auth().signOut(); // Ensure user is signed out on any login failure
							});
					});

				// Password Reset Logic
				const loginForm = document.getElementById("loginForm");
				const resetForm = document.getElementById("resetForm");
				const showResetFormLink = document.getElementById("showResetForm");
				const backToLoginLink = document.getElementById("backToLogin");
				const switchFormDiv = document.querySelector(".switch-form");

				showResetFormLink.addEventListener("click", function (e) {
					e.preventDefault();
					loginForm.style.display = "none";
					switchFormDiv.style.display = "none";
					resetForm.style.display = "block";
					document.getElementById("message").style.display = "none";
				});

				backToLoginLink.addEventListener("click", function (e) {
					e.preventDefault();
					resetForm.style.display = "none";
					loginForm.style.display = "block";
					switchFormDiv.style.display = "block";
					document.getElementById("resetMessage").style.display = "none";
				});

				resetForm.addEventListener("submit", function (e) {
					e.preventDefault();
					const email = document.getElementById("resetEmail").value;
					const resetMessageDiv = document.getElementById("resetMessage");

					firebase
						.auth()
						.sendPasswordResetEmail(email)
						.then(() => {
							resetMessageDiv.textContent =
								translations[currentLang].resetPasswordSuccess;
							resetMessageDiv.className = "message";
							resetMessageDiv.style.color = "green";
							resetMessageDiv.style.backgroundColor = "#d4edda";
							resetMessageDiv.style.borderColor = "#c3e6cb";
							resetMessageDiv.style.display = "block";
						})
						.catch((error) => {
							console.error("Reset password error:", error);
							resetMessageDiv.textContent =
								translations[currentLang].resetPasswordError;
							resetMessageDiv.className = "message error";
							resetMessageDiv.style.display = "block";
						});
				});
			});
		</script>
	</body>
</html>
