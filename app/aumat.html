<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Material Handling Checklist — Final v14 (PWA)</title>
<meta name="theme-color" content="#111827"/>
<link rel="manifest" href="manifest.webmanifest">
<link rel="icon" href="https://mokhamadabrar.github.io/construction-inspection/Logo-JO.png">
<style>
  :root{ --brand:#6a1b9a; --row:#f7f9fc; --header:#0ea5e9; --border:#d1d5db; --ok:#16a34a; --bad:#ef4444; --muted:#6b7280; }
  *{box-sizing:border-box}
  body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Arial;margin:0;color:#111827;background:#fff}
  .page{max-width:1050px;margin:16px auto;padding:16px}
  .title{color:var(--brand);text-align:center;font-weight:800;font-size:clamp(18px,4vw,28px);margin:0 0 6px}
  .logo-wrap{display:flex;justify-content:center;align-items:center;margin:6px 0 12px}
  .logo-wrap img{width:min(40vw,260px);height:auto;max-height:120px}
  .logo-caption{font-size:12px;color:#374151;text-align:center;margin-top:4px}

  /* Install banner */
  .install-banner{display:none;gap:8px;align-items:center;justify-content:space-between;background:#fff7ed;border:1px solid #fed7aa;border-radius:10px;padding:10px 12px;margin:8px 0}
  .install-banner.show{display:flex}
  .install-banner .msg{font-size:13px;color:#7c2d12}
  .install-banner .actions{display:flex;gap:8px}
  .install-btn{border:none;border-radius:10px;padding:8px 12px;font-weight:700;color:#fff;background:#0ea5e9}

  .langbar{display:flex;justify-content:flex-end;gap:10px;align-items:center;margin:-4px 0 8px;flex-wrap:wrap}
  .langbar .hint{font-size:12px;color:#374151;margin-right:4px}
  .lang-btn{display:inline-flex;align-items:center;gap:8px;border:1px solid var(--border);border-radius:999px;background:#fff;padding:8px 12px;cursor:pointer;user-select:none;box-shadow:0 1px 2px rgba(0,0,0,.04);min-height:44px}
  .lang-btn[aria-pressed="true"]{outline:2px solid #0ea5e9;outline-offset:2px;box-shadow:0 0 0 2px rgba(14,165,233,.15) inset}
  .lang-btn img{width:24px;height:auto;display:block}
  .lang-btn .lbl{font-size:13px;color:#111}
  @media (max-width:480px){ .lang-btn{padding:8px 10px} .lang-btn .lbl{display:none} .lang-btn img{width:28px} }

  .meta{display:grid;gap:8px 16px;grid-template-columns:repeat(6,1fr);font-size:13px;margin-bottom:8px}
  .meta .label{color:#374151}
  .meta input{width:100%;padding:6px 8px;border:1px solid var(--border);border-radius:6px}

  .chk-table{width:100%;border-collapse:separate;border-spacing:0;overflow:hidden;border:1px solid var(--border);border-radius:10px;margin-top:6px}
  .chk-table thead th{background:var(--header);color:#fff;padding:10px 8px;font-weight:700;font-size:13px;text-align:center;border-right:1px solid var(--header)}
  .chk-table thead th:last-child{border-right:none}
  .section-head{background:#e2f3fb;color:#0b4a6f;font-weight:700;padding:8px;font-size:13px;border-top:1px solid var(--border);border-bottom:1px solid var(--border)}
  .col-no{width:70px;text-align:center;font-weight:800;color:#0b4a6f}
  .chk-table td{padding:8px;border-top:1px solid var(--border)}
  .row-alt{background:var(--row)}
  .ques{font-size:13px;line-height:1.35}
  .yn{display:flex;gap:10px;align-items:center}
  .yn label{display:flex;gap:6px;align-items:center;font-size:13px}
  .yn input{width:18px;height:18px}

  .remarks{width:100%;min-height:40px;border:1px solid var(--border);border-radius:8px;padding:6px 8px;font-size:12px;resize:vertical}
  .subrow td{border-top:none;padding-top:4px;padding-bottom:8px}
  .remarks-cell{padding:6px 8px 6px}
  .remarks-wrap{display:flex;flex-direction:column;gap:4px}
  .counter{font-size:11px;color:#6b7280}
  .counter.limit{color:var(--bad);font-weight:700}

  .scores{display:grid;gap:10px;grid-template-columns:repeat(5,1fr);margin:12px 0 6px}
  .score-card{border:1px solid var(--border);border-radius:10px;background:#fafafa;padding:10px}
  .score-card h4{margin:0 0 8px;font-size:13px;color:#0b4a6f}
  .score-val{font-weight:800;font-size:18px}
  .badge{border-radius:999px;padding:3px 8px;font-size:11px;margin-left:8px;color:#fff;background:#111827}
  .good{background:var(--ok)!important} .bad{background:var(--bad)!important}

  .photos{display:grid;gap:12px;grid-template-columns:repeat(2,1fr);margin-top:10px}
  .photo-card{background:#4f81bd;border-radius:14px;padding:10px;color:#fff;min-height:210px;display:flex;flex-direction:column;gap:8px;break-inside:avoid}
  .photo-stage{flex:1;border:2px dashed rgba(255,255,255,.7);border-radius:12px;display:grid;place-items:center;overflow:hidden;background:rgba(255,255,255,.06)}
  .photo-stage img{max-width:100%;max-height:100%;object-fit:contain;display:block}
  .photo-actions{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
  .photo-actions input[type=file]{color:#fff;font-size:12px}
  .photo-desc{flex:1;min-width:120px;border:none;border-radius:8px;padding:6px 8px;font-size:12px}
  .photo-desc-print{display:none;margin-top:6px;font-size:12px;line-height:1.3;background:rgba(255,255,255,.12);padding:4px 6px;border-radius:6px}

  .footer{margin-top:14px;text-align:center;font-size:12px;color:#374151}
  .footer .line{height:1px;background:var(--border);margin:10px 0}
  .footer b{color:#111827}

  .toolbar{display:flex;gap:10px;justify-content:flex-end;margin-top:12px;flex-wrap:wrap}
  .btn{border:none;border-radius:10px;padding:10px 14px;font-weight:700;color:#fff}
  .btn.print{background:#111827}
  .btn.reset{background:#0ea5e9}
  .btn.wa{background:#25D366}
  .btn[disabled]{opacity:.7;cursor:progress}

  @media (max-width:800px){ .meta{grid-template-columns:repeat(2,1fr)} }
  @media (max-width:640px){ .photos{grid-template-columns:1fr} .col-no{width:64px} }

  @page{size:A4 portrait;margin:12mm}
  @media print{
    .toolbar{display:none!important}
    .page{margin:0;padding:0}
    .score-val{font-size:16px}
    .chk-table td{padding:6px}
    .logo-caption{display:none}
    textarea.remarks{
      border:none !important; outline:none !important; resize:none !important;
      overflow:visible !important; white-space:pre-wrap !important;
      font-size:12px !important; background:transparent !important;
      height:auto !important; min-height:unset !important;
      -webkit-appearance:none; appearance:none;
    }
    .counter{display:none}
    .photos{page-break-before: always; grid-template-columns: 1fr 1fr; gap: 6mm; margin-top: 0}
    .photo-card{background:#fff;color:#111;border:1px solid #ddd;padding:5mm;border-radius:6px;min-height:auto;height:120mm;break-inside:avoid;page-break-inside:avoid}
    .photo-stage{ border:1px solid #ccc; background:#fff; border-radius:4px }
    .photo-actions{display:none}
    .photo-desc-print{ display:block; font-size:11px; color:#111; background:transparent; padding:0; margin-top:3mm }
    .footer{font-size:11px}
  }
</style>
</head>
<body>
<div class="page" id="appRoot">
  <div class="title">MATERIAL HANDLING AUDIT</div>

  <div class="logo-wrap" aria-label="Logo PT ABC">
    <div>
      <img crossorigin="anonymous" referrerpolicy="no-referrer"
           src="https://mokhamadabrar.github.io/construction-inspection/Logo-abc.png"
           alt="PT ABC" />
      <div class="logo-caption">PT ABC</div>
    </div>
  </div>

  <!-- Install banner -->
  <div id="installBanner" class="install-banner" role="status" aria-live="polite">
    <div class="msg">Untuk kirim PDF langsung via WhatsApp, instal aplikasi web ini ke Home Screen dulu (PWA).</div>
    <div class="actions">
      <button id="btnInstall" class="install-btn">Install App</button>
    </div>
  </div>

  <!-- Language Buttons -->
  <div class="langbar" role="group" aria-label="Auto translate">
    <span class="hint">Auto translate:</span>
    <button id="btnID" type="button" class="lang-btn" aria-pressed="false" aria-label="Indonesia">
      <img src="/img/ID.svg" alt="ID"/>
      <span class="lbl">Indonesia</span>
    </button>
    <button id="btnEN" type="button" class="lang-btn" aria-pressed="false" aria-label="English">
      <img src="/img/EN.svg" alt="EN"/>
      <span class="lbl">English</span>
    </button>
  </div>

  <!-- Meta -->
  <div class="meta">
    <div class="label" data-i18n="label_site">Site Assesssor</div><input id="inp-assessor" placeholder="Nama Site Assesssor"/>
    <div class="label" data-i18n="label_project">Project</div><input id="inp-project" value="JKT" placeholder="Kode/Nama"/>
    <div class="label" data-i18n="label_date">Date</div><input id="inp-date" type="date"/>
    <div class="label" data-i18n="label_location">Location</div><input id="inp-location" placeholder="Lokasi"/>
    <div class="label" data-i18n="label_contractor">Kontraktor</div><input id="inp-contractor" placeholder="Nama Kontraktor"/>
  </div>

  <!-- === TABEL CHECKLIST persis seperti versi Anda === -->
  <table class="chk-table" id="chkTable">
    <thead>
      <tr>
        <th class="col-no" data-i18n="th_no">No.</th>
        <th data-i18n="th_question">Pertanyaan</th>
        <th data-i18n="th_yes">YES</th>
        <th data-i18n="th_no2">NO</th>
        <th data-i18n="th_na">N/A</th>
      </tr>
    </thead>

    <!-- ===== SECTION A ===== -->
    <tbody data-section="A">
      <tr><td class="section-head" colspan="5">A. METHOD OF WORK PLAN</td></tr>

      <tr class="row-alt">
        <td class="col-no">A1</td>
        <td colspan="4"><div class="ques">Apakah penempatan material telah sesuai dengan lokasi pada MSRA, dan telah sesuai dengan persyaratan tempat penyimpanan?</div></td>
      </tr>
      <tr class="subrow row-alt">
        <td></td>
        <td>
          <div class="yn">
            <label><input type="radio" name="A1" value="yes"> Ya</label>
            <label><input type="radio" name="A1" value="no"> Tidak</label>
            <label><input type="radio" name="A1" value="na"> N/A</label>
          </div>
        </td>
        <td colspan="3" class="remarks-cell">
          <div class="remarks-wrap">
            <textarea class="remarks" maxlength="70" placeholder="Remarks (maks 70 karakter)…"></textarea>
            <div class="counter">0/70</div>
          </div>
        </td>
      </tr>

      <tr>
        <td class="col-no">A2</td>
        <td colspan="4"><div class="ques">Apakah berat/dimensi material, metode memindahkan telah didiskusikan? (check MSRA dan bagaimana rute Kendaraan dan pertimbangkan berat beban material)</div></td>
      </tr>
      <tr class="subrow">
        <td></td>
        <td><div class="yn">
          <label><input type="radio" name="A2" value="yes"> Ya</label>
          <label><input type="radio" name="A2" value="no"> Tidak</label>
          <label><input type="radio" name="A2" value="na"> N/A</label>
        </div></td>
        <td colspan="3" class="remarks-cell">
          <div class="remarks-wrap">
            <textarea class="remarks" maxlength="70"></textarea>
            <div class="counter">0/70</div>
          </div>
        </td>
      </tr>

      <tr class="row-alt">
        <td class="col-no">A3</td>
        <td colspan="4"><div class="ques">Apakah penempatan material tidak menghalangi pejalan kaki, tersedia akses untuk pengambilan material, dan telah tersedia barricade?</div></td>
      </tr>
      <tr class="subrow row-alt">
        <td></td>
        <td><div class="yn">
          <label><input type="radio" name="A3" value="yes"> Ya</label>
          <label><input type="radio" name="A3" value="no"> Tidak</label>
          <label><input type="radio" name="A3" value="na"> N/A</label>
        </div></td>
        <td colspan="3" class="remarks-cell">
          <div class="remarks-wrap">
            <textarea class="remarks" maxlength="70"></textarea>
            <div class="counter">0/70</div>
          </div>
        </td>
      </tr>

      <tr>
        <td class="col-no">A4</td>
        <td colspan="4"><div class="ques">Apakah anda mengetahui batas max angkat manual adalah 18.14 kg. Dan jika material panjang atau >3 m harus diangkat lebih dari satu orang.</div></td>
      </tr>
      <tr class="subrow">
        <td></td>
        <td><div class="yn">
          <label><input type="radio" name="A4" value="yes"> Ya</label>
          <label><input type="radio" name="A4" value="no"> Tidak</label>
          <label><input type="radio" name="A4" value="na"> N/A</label>
        </div></td>
        <td colspan="3" class="remarks-cell">
          <div class="remarks-wrap">
            <textarea class="remarks" maxlength="70"></textarea>
            <div class="counter">0/70</div>
          </div>
        </td>
      </tr>
    </tbody>

    <!-- ===== SECTION B ===== -->
    <tbody data-section="B">
      <tr><td class="section-head" colspan="5">B. PEOPLE / COMPETENCE / QUALIFICATION</td></tr>

      <tr class="row-alt"><td class="col-no">B5</td><td colspan="4" class="ques">Kepada siapa anda melapor jika anda membutuhkan alat untuk memindahkan material anda?</td></tr>
      <tr class="subrow row-alt"><td></td><td><div class="yn">
        <label><input type="radio" name="B5" value="yes"> Ya</label>
        <label><input type="radio" name="B5" value="no"> Tidak</label>
        <label><input type="radio" name="B5" value="na"> N/A</label>
      </div></td><td colspan="3" class="remarks-cell">
        <div class="remarks-wrap">
          <textarea class="remarks" maxlength="70"></textarea>
          <div class="counter">0/70</div>
        </div>
      </td></tr>

      <tr><td class="col-no">B6</td><td colspan="4" class="ques">Apakah anda telah memeriksa bahwa alat pemindah atau pengangkat tersebut telah dilakukan checklist sebelum digunakan?</td></tr>
      <tr class="subrow"><td></td><td><div class="yn">
        <label><input type="radio" name="B6" value="yes"> Ya</label>
        <label><input type="radio" name="B6" value="no"> Tidak</label>
        <label><input type="radio" name="B6" value="na"> N/A</label>
      </div></td><td colspan="3" class="remarks-cell">
        <div class="remarks-wrap">
          <textarea class="remarks" maxlength="70"></textarea>
          <div class="counter">0/70</div>
        </div>
      </td></tr>

      <tr class="row-alt"><td class="col-no">B7</td><td colspan="4" class="ques">Apakah Operator alat pemindah/angkat telah memiliki lisensi (SIO) dan masih berlaku?</td></tr>
      <tr class="subrow row-alt"><td></td><td><div class="yn">
        <label><input type="radio" name="B7" value="yes"> Ya</label>
        <label><input type="radio" name="B7" value="no"> Tidak</label>
        <label><input type="radio" name="B7" value="na"> N/A</label>
      </div></td><td colspan="3" class="remarks-cell">
        <div class="remarks-wrap">
          <textarea class="remarks" maxlength="70"></textarea>
          <div class="counter">0/70</div>
        </div>
      </td></tr>
    </tbody>

    <!-- ===== SECTION C ===== -->
    <tbody data-section="C">
      <tr><td class="section-head" colspan="5">C. TOOLS / Equipments</td></tr>

      <tr class="row-alt"><td class="col-no">C8</td><td colspan="4" class="ques">Apakah sertifikasi alat angkat (SILO) tersedia dan masih berlaku?</td></tr>
      <tr class="subrow row-alt"><td></td><td><div class="yn">
        <label><input type="radio" name="C8" value="yes"> Ya</label>
        <label><input type="radio" name="C8" value="no"> Tidak</label>
        <label><input type="radio" name="C8" value="na"> N/A</label>
      </div></td><td colspan="3" class="remarks-cell">
        <div class="remarks-wrap">
          <textarea class="remarks" maxlength="70"></textarea>
          <div class="counter">0/70</div>
        </div>
      </td></tr>

      <tr><td class="col-no">C9</td><td colspan="4" class="ques">Apakah Alat pemindah (angkat) yang digunakan telah diperiksa sebelum didatangkan / dipakai.</td></tr>
      <tr class="subrow"><td></td><td><div class="yn">
        <label><input type="radio" name="C9" value="yes"> Ya</label>
        <label><input type="radio" name="C9" value="no"> Tidak</label>
        <label><input type="radio" name="C9" value="na"> N/A</label>
      </div></td><td colspan="3" class="remarks-cell">
        <div class="remarks-wrap">
          <textarea class="remarks" maxlength="70"></textarea>
          <div class="counter">0/70</div>
        </div>
      </td></tr>

      <tr class="row-alt"><td class="col-no">C10</td><td colspan="4" class="ques">Apakah Alat bantu lainnya telah diinspeksi & dinyatakan layak.</td></tr>
      <tr class="subrow row-alt"><td></td><td><div class="yn">
        <label><input type="radio" name="C10" value="yes"> Ya</label>
        <label><input type="radio" name="C10" value="no"> Tidak</label>
        <label><input type="radio" name="C10" value="na"> N/A</label>
      </div></td><td colspan="3" class="remarks-cell">
        <div class="remarks-wrap">
          <textarea class="remarks" maxlength="70"></textarea>
          <div class="counter">0/70</div>
        </div>
      </td></tr>

      <tr><td class="col-no">C11</td><td colspan="4" class="ques">Apakah PPE telah sesuai dengan aturan MSDS?</td></tr>
      <tr class="subrow"><td></td><td><div class="yn">
        <label><input type="radio" name="C11" value="yes"> Ya</label>
        <label><input type="radio" name="C11" value="no"> Tidak</label>
        <label><input type="radio" name="C11" value="na"> N/A</label>
      </div></td><td colspan="3" class="remarks-cell">
        <div class="remarks-wrap">
          <textarea class="remarks" maxlength="70"></textarea>
          <div class="counter">0/70</div>
        </div>
      </td></tr>
    </tbody>

    <!-- ===== SECTION D ===== -->
    <tbody data-section="D">
      <tr><td class="section-head" colspan="5">D. ENVIRONMENT MANAGEMENT / CLEAN WORKPLACE</td></tr>

      <tr class="row-alt"><td class="col-no">D12</td><td colspan="4" class="ques">Apakah anda telah memiliki tempat sampah untuk material sisa yang akan dibuang?</td></tr>
      <tr class="subrow row-alt"><td></td><td><div class="yn">
        <label><input type="radio" name="D12" value="yes"> Ya</label>
        <label><input type="radio" name="D12" value="no"> Tidak</label>
        <label><input type="radio" name="D12" value="na"> N/A</label>
      </div></td><td colspan="3" class="remarks-cell">
        <div class="remarks-wrap">
          <textarea class="remarks" maxlength="70"></textarea>
          <div class="counter">0/70</div>
        </div>
      </td></tr>

      <tr><td class="col-no">D13</td><td colspan="4" class="ques">Apakah anda mengetahui secara harian dimana lokasi koleksi point pembuangan sampah anda</td></tr>
      <tr class="subrow"><td></td><td><div class="yn">
        <label><input type="radio" name="D13" value="yes"> Ya</label>
        <label><input type="radio" name="D13" value="no"> Tidak</label>
        <label><input type="radio" name="D13" value="na"> N/A</label>
      </div></td><td colspan="3" class="remarks-cell">
        <div class="remarks-wrap">
          <textarea class="remarks" maxlength="70"></textarea>
          <div class="counter">0/70</div>
        </div>
      </td></tr>

      <tr class="row-alt"><td class="col-no">D14</td><td colspan="4" class="ques">Apakah anda telah melakukan kebersihan sebelum bekerja dan sesudah bekerja dan menata kembali peralatan</td></tr>
      <tr class="subrow row-alt"><td></td><td><div class="yn">
        <label><input type="radio" name="D14" value="yes"> Ya</label>
        <label><input type="radio" name="D14" value="no"> Tidak</label>
        <label><input type="radio" name="D14" value="na"> N/A</label>
      </div></td><td colspan="3" class="remarks-cell">
        <div class="remarks-wrap">
          <textarea class="remarks" maxlength="70"></textarea>
          <div class="counter">0/70</div>
        </div>
      </td></tr>

      <tr><td class="col-no">D15</td><td colspan="4" class="ques">Jika material anda didalam building apakah anda menyediakan Floor Protection dan menghindari terjadinya Debu</td></tr>
      <tr class="subrow"><td></td><td><div class="yn">
        <label><input type="radio" name="D15" value="yes"> Ya</label>
        <label><input type="radio" name="D15" value="no"> Tidak</label>
        <label><input type="radio" name="D15" value="na"> N/A</label>
      </div></td><td colspan="3" class="remarks-cell">
        <div class="remarks-wrap">
          <textarea class="remarks" maxlength="70"></textarea>
          <div class="counter">0/70</div>
        </div>
      </td></tr>
    </tbody>
  </table>

  <div class="scores">
    <div class="score-card"><h4>Score A</h4><div class="score-val" id="scoreA">0%</div></div>
    <div class="score-card"><h4>Score B</h4><div class="score-val" id="scoreB">0%</div></div>
    <div class="score-card"><h4>Score C</h4><div class="score-val" id="scoreC">0%</div></div>
    <div class="score-card"><h4>Score D</h4><div class="score-val" id="scoreD">0%</div></div>
    <div class="score-card"><h4>Total Score <span id="badge" class="badge">0/100</span></h4><div class="score-val" id="totalScore">0%</div></div>
  </div>

  <!-- Photos (UI) -->
  <div class="photos" id="photos">
    <div class="photo-card" data-slot="1">
      <div class="photo-stage"><span>Tambahkan Foto</span></div>
      <div class="photo-actions">
        <input type="file" accept="image/*" />
        <input type="text" class="photo-desc" maxlength="58" placeholder="Deskripsi foto (maks 58)…" />
      </div>
      <div class="photo-desc-print"></div>
    </div>
    <div class="photo-card" data-slot="2">
      <div class="photo-stage"><span>Tambahkan Foto</span></div>
      <div class="photo-actions">
        <input type="file" accept="image/*" />
        <input type="text" class="photo-desc" maxlength="58" placeholder="Deskripsi foto (maks 58)…" />
      </div>
      <div class="photo-desc-print"></div>
    </div>
    <div class="photo-card" data-slot="3">
      <div class="photo-stage"><span>Tambahkan Foto</span></div>
      <div class="photo-actions">
        <input type="file" accept="image/*" />
        <input type="text" class="photo-desc" maxlength="58" placeholder="Deskripsi foto (maks 58)…" />
      </div>
      <div class="photo-desc-print"></div>
    </div>
    <div class="photo-card" data-slot="4">
      <div class="photo-stage"><span>Tambahkan Foto</span></div>
      <div class="photo-actions">
        <input type="file" accept="image/*" />
        <input type="text" class="photo-desc" maxlength="58" placeholder="Deskripsi foto (maks 58)…" />
      </div>
      <div class="photo-desc-print"></div>
    </div>
  </div>

  <div class="toolbar">
    <button class="btn wa" id="waBtn">Send by WhatsApp</button>
    <button class="btn print" id="printBtn">Print PDF (A4)</button>
    <button class="btn reset" id="resetBtn">Reset</button>
  </div>
</div>

<div class="footer" role="contentinfo">
    <div class="line"></div>
    <div>@2025 Created &amp; Review by PT ABC</div>
    <div><b>Chin Chan James</b> (Safety Director)</div>
    <div>Application Design by <b>Gendewa</b> ver.1.0 @2025</div>
</div>

<script defer src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
<script>
(function(){
  /* ===== helpers ===== */
  const qsa=(s,r)=> (r||document).querySelectorAll(s);
  const qs=(s,r)=> (r||document).querySelector(s);

  /* ===== PWA: service worker & install prompt ===== */
  if ('serviceWorker' in navigator){
    navigator.serviceWorker.register('./sw.js').catch(()=>{});
  }
  let deferredPrompt=null;
  window.addEventListener('beforeinstallprompt', (e)=>{
    e.preventDefault();
    deferredPrompt=e;
    showInstallBanner(true);
  });
  function showInstallBanner(show){
    const b=qs('#installBanner'); if(!b) return;
    // tampilkan jika: tidak standalone ATAU share files tidak didukung
    const standalone = window.matchMedia('(display-mode: standalone)').matches || window.navigator.standalone;
    const canFileShare = ('canShare' in navigator) && (function(){ try{ return navigator.canShare({ files:[ new File(['x'],'x.txt',{type:'text/plain'}) ] }); }catch(e){ return false; }})();
    if (show && (!standalone || !canFileShare)) b.classList.add('show'); else b.classList.remove('show');
  }
  qs('#btnInstall').addEventListener('click', async ()=>{
    if (!deferredPrompt){ alert('Jika tombol tidak muncul, pilih “Add to Home screen” dari menu Chrome.'); return; }
    deferredPrompt.prompt();
    await deferredPrompt.userChoice;
    deferredPrompt=null;
    showInstallBanner(false);
  });

  /* ===== language (ID default) ===== */
  let currentLang='id';
  try{ currentLang = (localStorage.getItem('mhc_lang')==='en')?'en':'id'; }catch(e){}
  const getLang=()=>currentLang;

  function enforceMaxWithAlert(el, MAX, fieldName){
    if (el.value.length>MAX){
      el.value = el.value.slice(0,MAX);
      alert((getLang()==='en')?`Maximum ${MAX} characters for ${fieldName}.`:`Maksimal ${MAX} karakter untuk ${fieldName}.`);
      return true;
    } return false;
  }
  const MAX_REMARKS=70, MAX_DESC=58;

  /* ===== scoring ===== */
  function scoreSection(sec){
    const names=new Set(); qsa('input[type=radio]',sec).forEach(r=>names.add(r.name));
    let yes=0,den=0; names.forEach(n=>{
      const c=sec.querySelector(`input[name="${n}"]:checked`); if(!c||c.value==='na') return; den++; if(c.value==='yes') yes++;
    });
    return den?Math.round(100*yes/den):0;
  }
  function refreshScores(){
    const A=qs('tbody[data-section="A"]'), B=qs('tbody[data-section="B"]'), C=qs('tbody[data-section="C"]'), D=qs('tbody[data-section="D"]');
    const sA=scoreSection(A), sB=scoreSection(B), sC=scoreSection(C), sD=scoreSection(D);
    let yes=0,den=0; [A,B,C,D].forEach(sec=>{
      const names=new Set(); qsa('input[type=radio]',sec).forEach(r=>names.add(r.name));
      names.forEach(n=>{ const c=sec.querySelector(`input[name="${n}"]:checked`); if(!c||c.value==='na') return; den++; if(c.value==='yes') yes++; });
    });
    const total=den?Math.round(100*yes/den):0;
    qs('#scoreA').textContent=sA+'%'; qs('#scoreB').textContent=sB+'%'; qs('#scoreC').textContent=sC+'%'; qs('#scoreD').textContent=sD+'%';
    qs('#totalScore').textContent=total+'%'; const badge=qs('#badge'); badge.textContent=`${total}/100`; badge.classList.remove('good','bad'); badge.classList.add(total>=80?'good':'bad');
  }
  qsa('#chkTable input[type=radio]').forEach(r=>r.addEventListener('change',refreshScores)); refreshScores();

  /* ===== counters & inputs ===== */
  qsa('textarea.remarks').forEach(a=>{
    a.setAttribute('maxlength',String(MAX_REMARKS));
    const wrap=a.closest('.remarks-wrap'); const counter=wrap.querySelector('.counter');
    const upd=()=>{ enforceMaxWithAlert(a,MAX_REMARKS,'Remarks'); const len=a.value.length; counter.textContent=`${len}/${MAX_REMARKS}`; counter.classList.toggle('limit',len>=MAX_REMARKS); };
    a.addEventListener('input',upd); a.addEventListener('paste',()=>setTimeout(upd,0)); upd();
  });
  qsa('.photo-card input[type=file]').forEach(inp=>{
    inp.addEventListener('change',e=>{
      const f=e.target.files[0]; if(!f) return;
      const stage=e.target.closest('.photo-card').querySelector('.photo-stage');
      const img=document.createElement('img'); const rd=new FileReader();
      rd.onload=ev=>{ stage.innerHTML=''; img.src=ev.target.result; stage.appendChild(img); }; rd.readAsDataURL(f);
    });
  });
  qsa('.photo-card .photo-desc').forEach(desc=>{
    const pb=desc.closest('.photo-card').querySelector('.photo-desc-print');
    const sync=()=>{ enforceMaxWithAlert(desc,MAX_DESC,(getLang()==='en'?'Photo Description':'Deskripsi Foto')); pb.textContent=desc.value||''; };
    desc.setAttribute('maxlength',String(MAX_DESC)); desc.addEventListener('input',sync); desc.addEventListener('paste',()=>setTimeout(sync,0)); sync();
  });

  /* ===== i18n label/question (pakai baseline ID + EN) ===== */
  function getQMap(){
    const map={}; qsa('.chk-table tbody tr').forEach(tr=>{ const no=tr.querySelector('.col-no'); const q=tr.querySelector('.ques'); if(no&&q){ map[no.textContent.replace(/\s+/g,'').trim()]=q; }});
    return map;
  }
  const qMap=getQMap();
  const baselineID={}; Object.keys(qMap).forEach(k=>baselineID[k]=qMap[k].textContent.trim());
  const i18n={
    id:{labels:{label_site:"Site Assesssor",label_project:"Project",label_date:"Date",label_location:"Location",label_contractor:"Kontraktor",
      th_no:"No.",th_question:"Pertanyaan",th_yes:"YES",th_no2:"NO",th_na:"N/A",
      ph_assessor:"Nama Site Assesssor",ph_project:"Kode/Nama",ph_location:"Lokasi",ph_contractor:"Nama Kontraktor",
      ph_remarks:"Remarks (maks 70 karakter)…",ph_photo:"Deskripsi foto (maks 58)…",radio_yes:"Ya",radio_no:"Tidak",radio_na:"N/A"},
      questions:baselineID},
    en:{labels:{label_site:"Site Assessor",label_project:"Project",label_date:"Date",label_location:"Location",label_contractor:"Contractor",
      th_no:"No.",th_question:"Question",th_yes:"YES",th_no2:"NO",th_na:"N/A",
      ph_assessor:"Site assessor name",ph_project:"Code/Name",ph_location:"Location",ph_contractor:"Contractor name",
      ph_remarks:"Remarks (max 70 characters)…",ph_photo:"Photo description (max 58)…",radio_yes:"Yes",radio_no:"No",radio_na:"N/A"},
      questions:{
        A1:"Is the placement of materials compliant with the MSRA location and storage requirements?",
        A2:"Have the material weight/dimensions and movement method been discussed? (check the MSRA; plan vehicle route and consider load weight)",
        A3:"Does the material placement not obstruct pedestrians, provide access for picking, and are barricades provided?",
        A4:"Do you know the manual lifting limit is 18.14 kg per person, and loads longer than 3 m must be lifted by more than one person?",
        B5:"Whom do you report to if you need equipment to move your materials?",
        B6:"Have you checked that the handling/lifting equipment has been pre-use checklisted?",
        B7:"Do the handling/lifting equipment operators hold a valid license (SIO)?",
        C8:"Is the lifting equipment certification (SILO) available and valid?",
        C9:"Has the handling (lifting) equipment been inspected before being mobilized/used?",
        C10:"Have other auxiliary tools been inspected and declared fit for use?",
        C11:"Is the PPE in accordance with MSDS requirements?",
        D12:"Do you have waste bins for leftover materials to be disposed of?",
        D13:"Do you know the daily location of your waste collection points?",
        D14:"Do you clean before and after work and tidy up the tools?",
        D15:"If your materials are inside the building, do you provide floor protection and prevent dust generation?"
      }}
  };
  function setLabels(lang){
    qsa('[data-i18n]').forEach(el=>{ const key=el.getAttribute('data-i18n'); const t=i18n[lang].labels[key]; if(t) el.textContent=t; });
    qs('#inp-assessor').placeholder=i18n[lang].labels.ph_assessor;
    qs('#inp-project').placeholder=i18n[lang].labels.ph_project;
    qs('#inp-location').placeholder=i18n[lang].labels.ph_location;
    qs('#inp-contractor').placeholder=i18n[lang].labels.ph_contractor;
    qsa('textarea.remarks').forEach(t=>t.placeholder=i18n[lang].labels.ph_remarks);
    qsa('.photo-desc').forEach(t=>t.placeholder=i18n[lang].labels.ph_photo);
    const yes=i18n[lang].labels.radio_yes,no=i18n[lang].labels.radio_no,na=i18n[lang].labels.radio_na;
    qsa('.yn label').forEach(l=>{ const inp=l.querySelector('input'); if(!inp) return; const txt=(inp.value==='yes')?yes:(inp.value==='no')?no:na;
      let textNode=null; l.childNodes.forEach(n=>{ if(n.nodeType===3) textNode=n; }); if(textNode) textNode.nodeValue=' '+txt; else l.appendChild(document.createTextNode(' '+txt)); });
    const dict=i18n[lang].questions; Object.keys(qMap).forEach(k=>{ qMap[k].textContent=dict[k]||baselineID[k]; });
  }
  function applyLanguage(lang){ currentLang=(lang==='en')?'en':'id'; setLabels(currentLang);
    try{ localStorage.setItem('mhc_lang',currentLang);}catch(e){} qs('#btnID').setAttribute('aria-pressed',currentLang==='id'?'true':'false'); qs('#btnEN').setAttribute('aria-pressed',currentLang==='en'?'true':'false'); }
  applyLanguage(currentLang);
  qs('#btnID').addEventListener('click',()=>applyLanguage('id'));
  qs('#btnEN').addEventListener('click',()=>applyLanguage('en'));

  /* ===== Print & Reset ===== */
  qs('#printBtn').addEventListener('click',()=>window.print());
  qs('#resetBtn').addEventListener('click',()=>{
    qsa('#chkTable input[type=radio]').forEach(r=>r.checked=false);
    qsa('.remarks').forEach(t=>{ t.value=''; const wrap=t.closest('.remarks-wrap'); const c=wrap.querySelector('.counter'); c.textContent='0/'+MAX_REMARKS; c.classList.remove('limit'); });
    qsa('.photo-card').forEach(card=>{
      card.querySelector('.photo-stage').innerHTML='<span>Tambahkan Foto</span>';
      const f=card.querySelector('input[type=file]'); if(f) f.value='';
      const d=card.querySelector('.photo-desc'); if(d) d.value='';
      const pb=card.querySelector('.photo-desc-print'); if(pb) pb.textContent='';
    });
    refreshScores(); window.scrollTo(0,0);
  });

  /* ===== Export DOM untuk WA (hindari halaman kosong) ===== */
  function collectPhotos(){
    const out=[]; qsa('#photos .photo-card').forEach(c=>{
      const img=qs('.photo-stage img',c); const d=qs('.photo-desc',c);
      out.push({src: img?img.src:null, desc: d?d.value:''});
    }); return out;
  }
  function buildExportDOM(){
    const src=qs('#appRoot'); const clone=src.cloneNode(true); clone.id='exportRoot';
    const tb=clone.querySelector('.toolbar'); if(tb) tb.remove();
    // remarks -> div
    clone.querySelectorAll('textarea.remarks').forEach(ta=>{
      const div=document.createElement('div'); div.style.cssText='border:1px solid #d1d5db;border-radius:6px;padding:6px 8px;font-size:12px;white-space:pre-wrap;min-height:18px;background:#fff';
      div.textContent=ta.value||''; const wrap=ta.parentNode; wrap.replaceChild(div,ta); const counter=wrap.querySelector('.counter'); if(counter) counter.remove();
    });
    // rebuild photos 2x2 1 halaman
    const ph=collectPhotos(); const newPhotos=document.createElement('div'); newPhotos.className='photos';
    for (let s=0;s<4;s++){
      const card=document.createElement('div'); card.className='photo-card'; card.style.cssText='background:#fff;color:#111;border:1px solid #ddd;border-radius:6px;padding:12px';
      const stage=document.createElement('div'); stage.className='photo-stage'; stage.style.cssText='border:1px solid #ccc;background:#fff;border-radius:4px;display:grid;place-items:center;overflow:hidden;height:420px';
      if (ph[s] && ph[s].src){ const im=document.createElement('img'); im.src=ph[s].src; im.style.cssText='max-width:100%;max-height:100%;object-fit:contain;display:block'; stage.appendChild(im); }
      else { const sp=document.createElement('span'); sp.textContent=(getLang()==='en'?'No Photo':'Tidak ada foto'); sp.style.color='#555'; stage.appendChild(sp); }
      const cap=document.createElement('div'); cap.className='photo-desc-print'; cap.textContent=(ph[s]&&ph[s].desc)||''; cap.style.cssText='font-size:12px;margin-top:8px';
      card.appendChild(stage); card.appendChild(cap); newPhotos.appendChild(card);
    }
    const oldPhotos=clone.querySelector('.photos'); if(oldPhotos){ const br=document.createElement('div'); br.className='html2pdf__page-break'; oldPhotos.parentNode.insertBefore(br, oldPhotos); oldPhotos.replaceWith(newPhotos); }

    const style=document.createElement('style');
    style.textContent='#exportMount{position:fixed;left:-10000px;top:0;width:794px;z-index:-1}#exportRoot{width:794px;background:#fff;color:#111}#exportRoot *{page-break-before:auto !important;page-break-inside:auto !important}#exportRoot .photos{display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-top:0}';
    const mount=document.createElement('div'); mount.id='exportMount'; mount.appendChild(style); mount.appendChild(clone); document.body.appendChild(mount);
    return mount;
  }
  function filenameFromMeta(){
    const project=(qs('#inp-project').value||'PROJECT').replace(/\s+/g,'_'); const date=(qs('#inp-date').value||(new Date().toISOString().slice(0,10)));
    return `MHC_${project}_${date}.pdf`;
  }
  function buildPdfBlob(){
    return new Promise((resolve,reject)=>{
      if (typeof html2pdf==='undefined') return reject(new Error('html2pdf not loaded'));
      const mount=buildExportDOM(); const root=mount.querySelector('#exportRoot');
      const opt={ margin:[10,10,10,10], image:{type:'jpeg',quality:0.88}, html2canvas:{scale:2,useCORS:true,allowTaint:true,background:'#ffffff'}, jsPDF:{unit:'mm',format:'a4',orientation:'portrait'}, pagebreak:{mode:['css']} };
      try{
        const worker=html2pdf().set(opt).from(root).toPdf();
        worker.get('pdf').then(pdf=>{ const blob=pdf.output('blob'); document.body.removeChild(mount); resolve(blob); })
        .catch(err=>{ document.body.removeChild(mount); reject(err); });
      }catch(e){ document.body.removeChild(mount); reject(e); }
    });
  }

  /* ===== WhatsApp Share ===== */
  function shareViaWhatsApp(){
    const btn=qs('#waBtn'); const old=btn.textContent; btn.disabled=true; btn.textContent=(getLang()==='en'?'Preparing PDF…':'Menyiapkan PDF…');

    // Cek konteks
    const secureOK = window.isSecureContext;
    const canFileShare = ('canShare' in navigator) && (function(){ try{ return navigator.canShare({ files:[ new File(['x'],'x.txt',{type:'text/plain'}) ] }); }catch(e){ return false; }})();
    const standalone = window.matchMedia('(display-mode: standalone)').matches || window.navigator.standalone;

    if (!secureOK || !canFileShare){
      showInstallBanner(true);
    }

    buildPdfBlob().then(blob=>{
      let file; try{ file=new File([blob], filenameFromMeta(), {type:'application/pdf', lastModified:Date.now()}); }catch(e){ file=blob; file.name=filenameFromMeta(); file.type='application/pdf'; }

      if (secureOK && canFileShare){ // ini jalur auto attach
        btn.textContent=(getLang()==='en'?'Opening Share…':'Membuka Share…');
        return navigator.share({
          files:[file],
          title:'Material Handling Checklist',
          text:(getLang()==='en' ? 'Material Handling Checklist (PDF attached).' : 'Material Handling Checklist (PDF terlampir).')
        });
      } else {
        // Fallback: download + buka WA dengan pesan
        const url=URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download=filenameFromMeta(); a.click(); setTimeout(()=>URL.revokeObjectURL(url),60000);
        const msgID='PDF telah diunduh. Buka WhatsApp lalu lampirkan file dari penyimpanan.';
        const msgEN='PDF downloaded. Open WhatsApp and attach the file from storage.';
        const message=encodeURIComponent(getLang()==='en'?msgEN:msgID);
        const waUrl=(/Android/i.test(navigator.userAgent)?'https://wa.me/?text=':'https://web.whatsapp.com/send?text=')+message;
        window.open(waUrl,'_blank');
        alert(getLang()==='en'
          ? 'Untuk auto-attach file, buka laman ini melalui HTTPS dan instal sebagai App (Add to Home Screen).'
          : 'Agar bisa auto-attach file, buka laman ini via HTTPS dan instal sebagai Aplikasi (Add to Home Screen).');
      }
    }).catch(err=>{
      console.error(err);
      alert(getLang()==='en' ? 'Failed to generate or share PDF.' : 'Gagal membuat atau membagikan PDF.');
    }).then(()=>{ btn.textContent=old; btn.disabled=false; });
  }
  qs('#waBtn').addEventListener('click', shareViaWhatsApp);

  // tampilkan banner jika perlu pada load
  showInstallBanner(true);
})();
</script>
</body>
</html>
