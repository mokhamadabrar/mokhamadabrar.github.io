<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <!-- === SEO dan Media Sosial === -->
    <title>Form Observasi Keselamatan (K3) | Safety Observation Form</title>
    <meta name="description" content="Laporkan temuan keselamatan (K3), baik perilaku aman/tidak aman maupun kondisi aman/tidak aman, melalui formulir observasi digital ini.">
    <meta name="keywords" content="K3, HSE, Form Keselamatan, Safety Observation, Lapor K3, Form Observasi K3">
    
    <!-- Open Graph (untuk Facebook, LinkedIn, dll.) -->
    <meta property="og:title" content="Form Observasi Keselamatan (K3)">
    <meta property="og:description" content="Laporkan temuan K3 dengan mudah menggunakan formulir observasi online ini.">
    <meta property="og:type" content="website">
    <meta property="og:image" content="https://mokhamadabrar.github.io/img/observation20.webp">
    <meta property="og:url" content="https://mokhamadabrar.github.io/"> <!-- Ganti dengan URL Anda nanti -->
    
    <!-- Twitter Card -->
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:title" content="Form Observasi Keselamatan (K3)">
    <meta name="twitter:description" content="Laporkan temuan K3 dengan mudah menggunakan formulir observasi online ini.">
    <meta name="twitter:image" content="https://mokhamadabrar.github.io/img/observation20.webp">
    <!-- === AKHIR SEO === -->
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">

    <style>
        body {
            font-family: "Inter", -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: #f4f7f6;
            background-image: linear-gradient(to bottom right, #f8f9fa, #e9ecef);
            margin: 0;
            padding: 20px;
            color: #333;
            min-height: 100vh;
        }

        #logout-btn {
            position: absolute;
            top: 15px;
            right: 15px;
            background-color: rgba(244, 67, 54, 0.8);
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: bold;
            backdrop-filter: blur(3px);
            transition: background-color 0.3s ease;
        }

        #logout-btn:hover {
            background-color: #d32f2f;
        }

        .container {
            max-width: 800px;
            margin: 20px auto;
            background-color: #ffffff;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.08);
            border: none;
            overflow: hidden;
        }

        .header-banner {
            height: 180px;
            background-image: url('https://mokhamadabrar.github.io/img/construction.webp');
            background-size: cover;
            background-position: center center;
            margin: -20px -20px 25px -20px;
            position: relative; /* Penting untuk penempatan tombol bahasa */
        }

        .language-buttons {
            position: absolute;
            bottom: 15px;
            right: 15px;
            display: flex;
            gap: 10px;
            background-color: rgba(255, 255, 255, 0.7);
            padding: 5px 10px;
            border-radius: 8px;
            backdrop-filter: blur(3px);
        }

        .language-button {
            cursor: pointer;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            overflow: hidden;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            transition: transform 0.2s ease, box-shadow 0.2s ease;
            border: 2px solid transparent;
        }

        .language-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.3);
        }

        .language-button.active {
            border: 2px solid #007bff;
        }

        .language-button img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        h1 {
            text-align: center;
            color: #2c3e50;
            margin-bottom: 25px;
            font-size: 24px;
            font-weight: 700;
        }

        fieldset {
            border: none;
            background-color: #f9fafb;
            border-radius: 12px;
            padding: 25px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.04);
        }

        legend {
            font-weight: 600;
            color: #007bff;
            padding: 0 10px;
            font-size: 18px;
            border-bottom: 2px solid #007bff;
            padding-bottom: 5px;
        }

        .form-group {
            margin-bottom: 15px;
        }

        label {
            display: block;
            font-weight: 600;
            margin-bottom: 6px;
            font-size: 14px;
        }

        input[type="text"],
        input[type="date"],
        textarea,
        input[type="file"] {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid #dfe6e9;
            border-radius: 6px;
            box-sizing: border-box;
            font-size: 15px;
            background-color: #fdfdfd;
            transition: border-color 0.3s ease, box-shadow 0.3s ease;
        }

        input[type="text"]:focus,
        input[type="date"]:focus,
        textarea:focus {
            border-color: #007bff;
            box-shadow: 0 0 0 3px rgba(0,123,255,0.15);
            outline: none;
        }

        input[type="file"] {
            padding: 5px;
            background-color: #f4f7f6;
        }

        textarea {
            resize: vertical;
            min-height: 80px;
        }

        .radio-group div {
            margin-bottom: 8px;
            display: flex;
            align-items: center;
        }

        .radio-group label {
            font-weight: normal;
            margin-bottom: 0;
            margin-left: 8px;
            font-size: 15px;
        }

        input[type="radio"] {
            transform: scale(1.1);
            margin-right: 5px;
        }

        .checkbox-group {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 8px;
            background-color: #FFFFFF;
            padding: 15px;
            border-radius: 6px;
            border: 1px solid #dfe6e9;
        }

        .radio-group-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 8px;
            background-color: #FFFFFF;
            padding: 15px;
            border-radius: 6px;
            border: 1px solid #dfe6e9;
        }


        .checkbox-group div {
            display: flex;
            align-items: center;
        }

        .checkbox-group label {
            font-weight: normal;
            margin-bottom: 0;
            margin-left: 8px;
            font-size: 14px;
        }

        .radio-group-grid div {
            display: flex;
            align-items: center;
        }

        .radio-group-grid label {
            font-weight: normal;
            margin-bottom: 0;
            margin-left: 8px;
            font-size: 14px;
        }

        input[type="checkbox"] {
            transform: scale(1.1);
            margin-right: 5px;
        }

        @media (max-width: 600px) {
            .checkbox-group, .radio-group-grid {
                grid-template-columns: 1fr;
            }
            body { padding: 10px; }
            .container { padding: 15px; }
            fieldset { padding: 15px; }
            h1 { font-size: 22px; }
        }

        .submit-btn {
            display: block;
            width: 100%;
            padding: 12px 15px;
            background-image: linear-gradient(to right, #007bff, #0056b3);
            background-color: #007bff;
            color: white;
            border: none;
            border-radius: 6px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 10px rgba(0, 123, 255, 0.3);
        }

        .submit-btn:hover {
            background-image: linear-gradient(to right, #0056b3, #007bff);
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(0, 123, 255, 0.4);
        }
        
        /* --- Tombol WhatsApp BARU --- */
        .whatsapp-btn {
            display: inline-flex; /* Menggunakan flex untuk ikon + teks */
            align-items: center;
            justify-content: center;
            gap: 10px; /* Jarak antara ikon dan teks */
            width: 100%;
            padding: 12px 15px;
            margin-top: 15px; /* Jarak dari tombol submit */
            background-image: linear-gradient(to right, #25D366, #128C7E); /* Gradient Hijau WhatsApp */
            background-color: #25D366; /* Fallback */
            color: white;
            border: none;
            border-radius: 6px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 10px rgba(37, 211, 102, 0.3);
        }

        .whatsapp-btn:hover {
            background-image: linear-gradient(to right, #128C7E, #25D366);
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(37, 211, 102, 0.4);
        }
        
        .whatsapp-btn svg {
            width: 20px;
            height: 20px;
            fill: white; /* Mewarnai ikon SVG */
        }
        /* --- AKHIR CSS BARU --- */

        #formMessage {
            text-align: center;
            font-weight: bold;
            padding: 10px;
            border-radius: 5px;
            margin-bottom: 15px;
            display: none; 
        }

        #formMessage.success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
            display: block;
        }

        #formMessage.error {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
            display: block;
        }
    </style>
</head>
<body>
    <script>
        const loggedInUser = JSON.parse(sessionStorage.getItem('loggedInUser'));
        if (!loggedInUser) {
            window.location.href = 'login.html';
        }
    </script>

    <div class="container">
        <div class="header-banner">
            <button id="logout-btn">Logout</button>
            <div class="language-buttons">
                <div class="language-button" id="lang-id" data-lang="id">
                    <img src="https://mokhamadabrar.github.io/img/ID.svg" alt="Bahasa Indonesia">
                </div>
                <div class="language-button active" id="lang-en" data-lang="en">
                    <img src="https://mokhamadabrar.github.io/img/EN.svg" alt="English">
                </div>
            </div>
        </div>

        <form id="safetyForm">
            <h1 data-key="formTitle">Form Observasi Keselamatan (K3)</h1>
            
            <div id="formMessage"></div>

            <fieldset>
                <legend data-key="reporterInfo">Informasi Pelapor</legend>
                <div class="form-group">
                    <label for="observerName" data-key="observerNameLabel">Nama Observer:</label>
                    <input type="text" id="observerName" name="observerName" required>
                </div>
                <div class="form-group">
                    <label for="observerCompany" data-key="observerCompanyLabel">Perusahaan:</label>
                    <input type="text" id="observerCompany" name="observerCompany">
                </div>
                <div class="form-group">
                    <label for="observerPosition" data-key="observerPositionLabel">Jabatan:</label>
                    <div class="radio-group" id="observerPosition">
                        <div><input type="radio" id="pos-cm" name="observerPosition" value="Construction Manager" required><label for="pos-cm">Construction Manager</label></div>
                        <div><input type="radio" id="pos-sm" name="observerPosition" value="Site Manager"><label for="pos-sm">Site Manager</label></div>
                        <div><input type="radio" id="pos-cs" name="observerPosition" value="Construction Supervisor"><label for="pos-cs">Construction Supervisor</label></div>
                        <div><input type="radio" id="pos-ss" name="observerPosition" value="Safety Supervisor"><label for="pos-ss">Safety Supervisor</label></div>
                        <div><input type="radio" id="pos-sem" name="observerPosition" value="Safety Manager"><label for="pos-sem">Safety Manager</label></div>
                    </div>
                </div>
                <div class="form-group">
                    <label for="obsLocation" data-key="obsLocationLabel">Lokasi Observasi:</label>
                    <input type="text" id="obsLocation" name="obsLocation" data-placeholder-key="obsLocationPlaceholder" placeholder="Contoh: Area Workshop, Gudang B" required>
                </div>
            </fieldset>

            <fieldset>
                <legend data-key="observationDetails">Detail Observasi</legend>
                <div class="form-group">
                    <label for="obsDate" data-key="obsDateLabel">Tanggal Observasi:</label>
                    <input type="date" id="obsDate" name="obsDate" required>
                </div>
                
                <div class="form-group">
                    <label data-key="categoriesLabel">Kategori Observasi:</label>
                    <div class="radio-group-grid">
                        <div><input type="radio" id="cat-heights" name="category" value="Working from Heights" required><label for="cat-heights" data-key="catHeights">Working from Heights</label></div>
                        <div><input type="radio" id="cat-lifting" name="category" value="Lifting Operations"><label for="cat-lifting" data-key="catLifting">Lifting Operations</label></div>
                        <div><input type="radio" id="cat-mobile" name="category" value="Mobile Equipment"><label for="cat-mobile" data-key="catMobile">Mobile Equipment</label></div>
                        <div><input type="radio" id="cat-ground" name="category" value="Ground Disturbance"><label for="cat-ground" data-key="catGround">Ground Disturbance</label></div>
                        <div><input type="radio" id="cat-driving" name="category" value="Driving & Off-Road Vehicles"><label for="cat-driving" data-key="catDriving">Driving & Off-Road Vehicles</label></div>
                        <div><input type="radio" id="cat-material" name="category" value="Material Handling"><label for="cat-material" data-key="catMaterial">Material Handling</label></div>
                        <div><input type="radio" id="cat-energy" name="category" value="Energy Isolation"><label for="cat-energy" data-key="catEnergy">Energy Isolation</label></div>
                        <div><input type="radio" id="cat-confined" name="category" value="Confined Spaces"><label for="cat-confined" data-key="catConfined">Confined Spaces</label></div>
                        <div><input type="radio" id="cat-electrical" name="category" value="Electrical"><label for="cat-electrical" data-key="catElectrical">Electrical</label></div>
                        <div><input type="radio" id="cat-noise" name="category" value="Noise"><label for="cat-noise" data-key="catNoise">Noise</label></div>
                        <div><input type="radio" id="cat-thermal" name="category" value="Thermal Stress"><label for="cat-thermal" data-key="catThermal">Thermal Stress</label></div>
                        <div><input type="radio" id="cat-hazardous" name="category" value="Hazardous Materials"><label for="cat-hazardous" data-key="catHazardous">Hazardous Materials</label></div>
                        <div><input type="radio" id="cat-nonhra" name="category" value="Non HRA"><label for="cat-nonhra" data-key="catNonHRA">Non HRA</label></div>
                        <div><input type="radio" id="cat-other" name="category" value="Lain Lain"><label for="cat-other" data-key="catOther">Lain Lain</label></div>
                    </div>
                </div>

                <div class="form-group">
                    <label data-key="obsTypeLabel">Jenis Observasi:</label>
                    <div class="radio-group">
                        <div>
                            <input type="radio" id="safeAct" name="obsType" value="Perilaku Aman" required>
                            <label for="safeAct" data-key="safeAct">Perilaku Aman (Safe Act)</label>
                        </div>
                        <div>
                            <input type="radio" id="unsafeAct" name="obsType" value="Perilaku Tidak Aman">
                            <label for="unsafeAct" data-key="unsafeAct">Perilaku Tidak Aman (Unsafe Act)</label>
                        </div>
                        <div>
                            <input type="radio" id="safeCondition" name="obsType" value="Kondisi Aman">
                            <label for="safeCondition" data-key="safeCondition">Kondisi Aman (Safe Condition)</label>
                        </div>
                        <div>
                            <input type="radio" id="unsafeCondition" name="obsType" value="Kondisi Tidak Aman">
                            <label for="unsafeCondition" data-key="unsafeCondition">Kondisi Tidak Aman (Unsafe Condition)</label>
                        </div>
                    </div>
                </div>

                <div class="form-group">
                    <label for="description" data-key="descriptionLabel">Deskripsi Observasi:</label>
                    <textarea id="description" name="description" rows="5" data-placeholder-key="descriptionPlaceholder" placeholder="Jelaskan apa yang Anda lihat..." required></textarea>
                </div>
                
                <div class="form-group">
                    <label for="immediateAction" data-key="immediateActionLabel">Tindakan Segera yang Diambil (Jika ada):</label>
                    <textarea id="immediateAction" name="immediateAction" rows="3" data-placeholder-key="immediateActionPlaceholder" placeholder="Contoh: Menegur pekerja, menghentikan pekerjaan, membersihkan tumpahan..."></textarea>
                </div>

                <div class="form-group">
                    <label for="recommendation" data-key="recommendationLabel">Rekomendasi / Saran Perbaikan:</label>
                    <textarea id="recommendation" name="recommendation" rows="3" data-placeholder-key="recommendationPlaceholder" placeholder="Contoh: Perlu training ulang, pasang rambu baru, perbaiki mesin..."></textarea>
                </div>

                <div class="form-group">
                    <label for="uploadPhoto" data-key="uploadPhotoLabel">Unggah Foto (Opsional):</label>
                    <input type="file" id="uploadPhoto" name="uploadPhoto" accept="image/*">
                </div>
            </fieldset>

            <button type="submit" class="submit-btn" data-key="submitButton" name="submitAction" value="submit">Kirim Laporan</button>
            
            <!-- === Tombol WhatsApp BARU === -->
            <button type="submit" id="whatsapp-share-btn" class="whatsapp-btn" name="submitAction" value="whatsapp">
                <!-- Ikon SVG WhatsApp -->
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12.04 2C6.58 2 2.13 6.45 2.13 11.91C2.13 13.66 2.59 15.36 3.45 16.86L2.05 22L7.31 20.6C8.75 21.38 10.36 21.82 12.04 21.82C17.5 21.82 21.95 17.37 21.95 11.91C21.95 6.45 17.5 2 12.04 2M16.56 15.29C16.31 15.89 15.1 16.5 14.76 16.56C14.42 16.62 13.27 16.11 12.22 15.15C10.92 14.01 10.07 12.61 9.87 12.3C9.67 11.99 9.54 11.82 9.3 11.38C9.06 10.94 8.61 10.5 8.16 10.5C7.71 10.5 7.32 10.5 7.08 10.5C6.84 10.5 6.51 10.59 6.22 11.14C5.93 11.69 5.23 12.44 5.23 13.6C5.23 14.76 6.25 15.82 6.45 16.03C6.65 16.23 8.01 18.2 9.94 19.02C11.67 19.75 12.63 19.41 13.22 19.32C13.81 19.23 14.95 18.63 15.24 18.03C15.53 17.43 15.53 16.92 15.44 16.77C15.34 16.62 15.1 16.53 14.86 16.41C14.61 16.29 13.56 15.78 13.31 15.69C13.07 15.6 12.9 15.54 12.73 15.81C12.56 16.08 12.01 16.68 11.86 16.86C11.71 17.04 11.56 17.07 11.31 16.95C11.07 16.83 10.15 16.53 9.06 15.58C8.18 14.81 7.6 13.81 7.42 13.5C7.24 13.19 7.36 13.03 7.5 12.89C7.63 12.76 7.79 12.58 7.95 12.41C8.11 12.24 8.17 12.11 8.26 11.97C8.35 11.83 8.32 11.68 8.26 11.59C8.2 11.5 7.71 10.24 7.5 9.77C7.29 9.31 7.08 9.34 6.91 9.34C6.75 9.34 6.58 9.31 6.41 9.31C6.24 9.31 5.97 9.37 5.72 9.87C5.47 10.37 4.9 11.12 4.9 12.29C4.9 13.46 5.75 14.52 5.95 14.72C6.15 14.92 7.51 16.92 9.44 17.74C11.17 18.47 12.13 18.13 12.72 18.04C13.31 17.95 14.45 17.35 14.74 16.75C15.03 16.15 15.03 15.64 14.94 15.49C14.84 15.34 14.6 15.25 14.36 15.13C14.11 15.01 13.06 14.5 12.82 14.41C12.57 14.32 12.39 14.26 12.22 14.53C12.05 14.8 11.5 15.4 11.35 15.58C11.2 15.76 11.05 15.79 10.8 15.67C10.56 15.55 9.64 15.25 8.55 14.3C7.67 13.53 7.09 12.53 6.91 12.22C6.73 11.91 6.85 11.75 6.99 11.61C7.12 11.48 7.28 11.3 7.44 11.13C7.6 10.96 7.66 10.83 7.75 10.69C7.84 10.55 7.81 10.4 7.75 10.31C7.69 10.22 7.2 8.96 7 8.49C6.81 8.03 6.6 8.06 6.43 8.06C6.27 8.06 6.1 8.03 5.93 8.03C5.76 8.03 5.49 8.09 5.24 8.59C4.99 9.09 4.42 9.84 4.42 11.01C4.42 12.18 5.27 13.24 5.47 13.44C5.67 13.64 7.03 15.64 8.96 16.46C10.69 17.19 11.65 16.85 12.24 16.76C12.83 16.67 13.97 16.07 14.26 15.47C14.55 14.87 14.55 14.36 14.46 14.21C14.36 14.06 14.12 13.97 13.88 13.85C13.63 13.73 12.58 13.22 12.34 13.13C12.09 13.04 11.92 12.98 11.75 13.25C11.58 13.52 11.03 14.12 10.88 14.3C10.73 14.48 10.58 14.51 10.33 14.39C10.09 14.27 9.17 13.97 8.08 13.02C7.19 12.25 6.59 11.25 6.41 10.94C6.23 10.63 6.35 10.47 6.49 10.33C6.62 10.2 6.78 10.02 6.94 9.85C7.1 9.68 7.16 9.55 7.25 9.41C7.34 9.27 7.31 9.12 7.25 9.03C7.19 8.94 6.7 7.68 6.5 7.21C6.29 6.75 6.08 6.78 5.91 6.78C5.75 6.78 5.58 6.75 5.41 6.75C5.24 6.75 4.97 6.81 4.72 7.31C4.47 7.81 3.9 8.56 3.9 9.73C3.9 10.9 4.75 11.96 4.95 12.16C5.15 12.36 6.51 14.36 8.44 15.18C10.17 15.91 11.13 15.57 11.72 15.48C12.31 15.39 13.45 14.79 13.74 14.19C14.03 13.59 14.03 13.08 13.94 12.93C13.84 12.78 13.6 12.69 13.36 12.57C13.11 12.45 12.06 11.94 11.82 11.85C11.57 11.76 11.4 11.7 11.23 11.97C11.06 12.24 10.51 12.84 10.36 13.02C10.21 13.2 10.06 13.23 9.81 13.11C9.57 12.99 8.65 12.69 7.56 11.74C6.67 10.97 6.08 9.97 5.9 9.66C5.72 9.35 5.84 9.19 5.98 9.05C6.11 8.92 6.27 8.74 6.43 8.57C6.59 8.4 6.65 8.27 6.74 8.13C6.83 7.99 6.8 7.84 6.74 7.75C6.68 7.66 6.19 6.4 5.99 5.93C5.78 5.47 5.57 5.5 5.4 5.5C5.24 5.5 5.07 5.47 4.9 5.47C4.73 5.47 4.46 5.53 4.21 6.03C3.96 6.53 3.4 7.28 3.4 8.45C3.4 9.62 4.25 10.68 4.45 10.88C4.65 11.08 6.01 13.08 7.94 13.9C9.67 14.63 10.63 14.29 11.22 14.2C11.81 14.11 12.95 13.51 13.24 12.91C13.53 12.31 13.53 11.8 13.44 11.65C13.34 11.5 13.1 11.41 12.86 11.29C12.61 11.17 11.56 10.66 11.32 10.57C11.07 10.48 10.9 10.42 10.73 10.69C10.56 10.96 10.01 11.56 9.86 11.74C9.71 11.92 9.56 11.95 9.31 11.83C9.07 11.71 8.15 11.41 7.06 10.46C6.17 9.69 5.58 8.69 5.4 8.38C5.22 8.07 5.34 7.91 5.48 7.77C5.61 7.64 5.77 7.46 5.93 7.29C6.09 7.12 6.15 6.99 6.24 6.85C6.33 6.71 6.3 6.56 6.24 6.47C6.18 6.38 5.69 5.12 5.49 4.65C5.28 4.19 5.07 4.22 4.9 4.22C4.74 4.22 4.57 4.19 4.4 4.19C4.23 4.19 3.96 4.25 3.71 4.75C3.46 5.25 2.9 5.9 2.9 7.17C2.9 8.34 3.75 9.4 3.95 9.6C4.15 9.8 5.51 11.8 7.44 12.62C9.17 13.35 10.13 13.01 10.72 12.92C11.31 12.83 12.45 12.23 12.74 11.63C13.03 11.03 13.03 10.52 12.94 10.37C12.84 10.22 12.6 10.13 12.36 10.01C12.11 9.89 11.06 9.38 10.82 9.29C10.57 9.2 10.4 9.14 10.23 9.41C10.06 9.68 9.51 10.28 9.36 10.46C9.21 10.64 9.06 10.67 8.81 10.55C8.57 10.43 7.65 10.13 6.56 9.18C5.67 8.41 5.08 7.41 4.9 7.1C4.72 6.79 4.84 6.63 4.98 6.49C5.11 6.36 5.27 6.18 5.43 6.01C5.59 5.84 5.65 5.71 5.74 5.57C5.83 5.43 5.8 5.28 5.74 5.19C5.68 5.1 5.19 3.84 4.99 3.37C4.78 2.91 4.57 2.94 4.4 2.94C4.24 2.94 4.07 2.91 3.9 2.91C3.73 2.91 3.46 2.97 3.21 3.47C2.96 3.97 2.4 4.72 2.4 5.89C2.4 7.06 3.25 8.12 3.45 8.32C3.65 8.52 5.01 10.52 6.94 11.34C8.67 12.07 9.63 11.73 10.22 11.64C10.81 11.55 11.95 10.95 12.24 10.35C12.53 9.75 12.53 9.24 12.44 9.09C12.34 8.94 12.1 8.85 11.86 8.73C11.61 8.61 10.56 8.1 10.32 8.01C10.07 7.92 9.9 7.86 9.73 8.13C9.56 8.4 9.01 9 8.86 9.18C8.71 9.36 8.56 9.39 8.31 9.27C8.07 9.15 7.15 8.85 6.06 7.9C5.17 7.13 4.58 6.13 4.4 5.82C4.22 5.51 4.34 5.35 4.48 5.21C4.61 5.08 4.77 4.9 4.93 4.73C5.09 4.56 5.15 4.43 5.24 4.29C5.33 4.15 5.3 4 5.24 3.91C5.18 3.82 4.69 2.56 4.49 2.09C4.28 1.63 4.07 1.66 3.9 1.66C3.74 1.66 3.57 1.63 3.4 1.63C3.23 1.63 2.96 1.69 2.71 2.19C2.46 2.69 1.9 3.44 1.9 4.61C1.9 5.78 2.75 6.84 2.95 7.04C3.15 7.24 4.51 9.24 6.44 10.06C8.17 10.79 9.13 10.45 9.72 10.36C10.31 10.27 11.45 9.67 11.74 9.07C12.03 8.47 12.03 7.96 11.94 7.81C11.84 7.66 11.6 7.57 11.36 7.45C11.11 7.33 10.06 6.82 9.82 6.73C9.57 6.64 9.4 6.58 9.23 6.85C9.06 7.12 8.51 7.72 8.36 7.9C8.21 8.08 8.06 8.11 7.81 7.99C7.57 7.87 6.65 7.57 5.56 6.62C4.67 5.85 4.08 4.85 3.9 4.54C3.72 4.23 3.84 4.07 3.98 3.93C4.11 3.8 4.27 3.62 4.43 3.45C4.59 3.28 4.65 3.15 4.74 3.01C4.83 2.87 4.8 2.72 4.74 2.63C4.68 2.54 4.19 1.28 3.99 0.81C3.78 0.35 3.57 0.38 3.4 0.38C3.24 0.38 3.07 0.35 2.9 0.35C2.73 0.35 2.46 0.41 2.21 0.91C1.96 1.41 1.4 2.16 1.4 3.33C1.4 4.5 2.25 5.56 2.45 5.76C2.65 5.96 4.01 7.96 5.94 8.78C7.67 9.51 8.63 9.17 9.22 9.08C9.81 8.99 10.95 8.39 11.24 7.79C11.53 7.19 11.53 6.68 11.44 6.53C11.34 6.38 11.1 6.29 10.86 6.17C10.61 6.05 9.56 5.54 9.32 5.45C9.07 5.36 8.9 5.3 8.73 5.57C8.56 5.84 8.01 6.44 7.86 6.62C7.71 6.8 7.56 6.83 7.31 6.71C7.07 6.59 6.15 6.29 5.06 5.34C4.17 4.57 3.58 3.57 3.4 3.26C3.22 2.95 3.34 2.79 3.48 2.65C3.61 2.52 3.77 2.34 3.93 2.17C4.09 2 4.15 1.87 4.24 1.73C4.33 1.59 4.3 1.44 4.24 1.35C4.18 1.26 3.69 0 3.49 -0.47C3.28 -0.93 3.07 -0.9 2.9 -0.9C2.74 -0.9 2.57 -0.93 2.4 -0.93C2.23 -0.93 1.96 -0.87 1.71 -0.37C1.46 0.13 0.9 0.88 0.9 2.05C0.9 3.22 1.75 4.28 1.95 4.48C2.15 4.68 3.51 6.68 5.44 7.5C7.17 8.23 8.13 7.89 8.72 7.8C9.31 7.71 10.45 7.11 10.74 6.51C11.03 5.91 11.03 5.4 10.94 5.25C10.84 5.1 10.6 5.01 10.36 4.89C10.11 4.77 9.06 4.26 8.82 4.17C8.57 4.08 8.4 4.02 8.23 4.29C8.06 4.56 7.51 5.16 7.36 5.34C7.21 5.52 7.06 5.55 6.81 5.43C6.57 5.31 5.65 5.01 4.56 4.06C3.67 3.29 3.08 2.29 2.9 1.98C2.72 1.67 2.84 1.51 2.98 1.37C3.11 1.24 3.27 1.06 3.43 0.89C3.59 0.72 3.65 0.59 3.74 0.45C3.83 0.31 3.8 0.16 3.74 0.07C3.68 -0.02 3.19 -1.28 2.99 -1.75C2.78 -2.21 2.57 -2.18 2.4 -2.18Z"/></svg>
                <span data-key="shareButton">Bagikan ke WhatsApp</span>
            </button>
        </form>
    </div>

    <!-- Firebase Scripts -->
    <script src="https://www.gstatic.com/firebasejs/8.6.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.6.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.6.1/firebase-firestore.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.6.1/firebase-storage.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/browser-image-compression@2.0.2/dist/browser-image-compression.js"></script>
    <script src="js/firebase-init.js"></script>

    <script>
        document.addEventListener("DOMContentLoaded", function() {
            // --- AUTO-FILL & USER SESSION ---
            const loggedInUser = JSON.parse(sessionStorage.getItem('loggedInUser'));
            if (!loggedInUser) {
                window.location.href = 'login.html';
            }
            
            document.getElementById('logout-btn').addEventListener('click', function() {
                sessionStorage.removeItem('loggedInUser');
                window.location.href = 'login.html';
            });

            function loadReporterInfo() {
                // Try to get name from localStorage first
                let name = localStorage.getItem(`${loggedInUser.uid}_reporterName`);
                
                // If name is not in localStorage, try getting it from the logged-in user's session
                if (!name && loggedInUser && loggedInUser.displayName) {
                    name = loggedInUser.displayName;
                }

                const company = localStorage.getItem(`${loggedInUser.uid}_reporterCompany`);
                const position = localStorage.getItem(`${loggedInUser.uid}_reporterPosition`);
                const location = localStorage.getItem(`${loggedInUser.uid}_reporterLocation`);

                if (name) document.getElementById('observerName').value = name;
                if (company) document.getElementById('observerCompany').value = company;
                if (location) document.getElementById('obsLocation').value = location;
                
                if (position) {
                    const positionRadio = document.querySelector(`input[name="observerPosition"][value="${position}"]`);
                    if (positionRadio) {
                        positionRadio.checked = true;
                    }
                }
            }

            function saveReporterInfo() {
                const selectedPosition = document.querySelector('input[name="observerPosition"]:checked');
                
                localStorage.setItem(`${loggedInUser.uid}_reporterName`, document.getElementById('observerName').value);
                localStorage.setItem(`${loggedInUser.uid}_reporterCompany`, document.getElementById('observerCompany').value);
                localStorage.setItem(`${loggedInUser.uid}_reporterLocation`, document.getElementById('obsLocation').value);
                if (selectedPosition) {
                    localStorage.setItem(`${loggedInUser.uid}_reporterPosition`, selectedPosition.value);
                }
            }

            loadReporterInfo();

            // --- FORM & TRANSLATION SETUP ---
            const safetyForm = document.getElementById("safetyForm");
            const messageDiv = document.getElementById("formMessage");
            const submitButton = safetyForm.querySelector('.submit-btn');
            const langButtons = document.querySelectorAll(".language-button");
            const whatsAppBtn = document.getElementById('whatsapp-share-btn');

            const translations = {
                'id': {
                    formTitle: "Form Observasi Keselamatan (K3)",
                    reporterInfo: "Informasi Pelapor",
                    observerNameLabel: "Nama Observer:",
                    observerCompanyLabel: "Perusahaan:",
                    observerPositionLabel: "Jabatan:",
                    obsLocationLabel: "Lokasi Observasi:",
                    obsLocationPlaceholder: "Contoh: Area Workshop, Gudang B",
                    observationDetails: "Detail Observasi",
                    obsDateLabel: "Tanggal Observasi:",
                    categoriesLabel: "Kategori Observasi:",
                    catHeights: "Bekerja di Ketinggian",
                    catLifting: "Operasi Pengangkatan",
                    catMobile: "Peralatan Bergerak",
                    catGround: "Gangguan Tanah",
                    catDriving: "Mengemudi & Kendaraan Off-Road",
                    catMaterial: "Penanganan Material",
                    catEnergy: "Isolasi Energi",
                    catConfined: "Ruang Terbatas",
                    catElectrical: "Listrik",
                    catNoise: "Kebisingan",
                    catThermal: "Stres Termal",
                    catHazardous: "Bahan Berbahaya",
                    catNonHRA: "Non HRA",
                    catOther: "Lain-Lain",
                    obsTypeLabel: "Jenis Observasi:",
                    safeAct: "Perilaku Aman (Safe Act)",
                    unsafeAct: "Perilaku Tidak Aman (Unsafe Act)",
                    safeCondition: "Kondisi Aman (Safe Condition)",
                    unsafeCondition: "Kondisi Tidak Aman (Unsafe Condition)",
                    descriptionLabel: "Deskripsi Observasi:",
                    descriptionPlaceholder: "Jelaskan apa yang Anda lihat...",
                    immediateActionLabel: "Tindakan Segera yang Diambil (Jika ada):",
                    immediateActionPlaceholder: "Contoh: Menegur pekerja, menghentikan pekerjaan, membersihkan tumpahan...",
                    recommendationLabel: "Rekomendasi / Saran Perbaikan:",
                    recommendationPlaceholder: "Contoh: Perlu training ulang, pasang rambu baru, perbaiki mesin...",
                    uploadPhotoLabel: "Unggah Foto (Opsional):",
                    submitButton: "Kirim Laporan",
                    submittingButton: "Mengirim...",
                    successMessage: "<strong>Laporan berhasil dikirim!</strong> Terima kasih atas observasi Anda.",
                    errorMessage: "<strong>Terjadi kesalahan saat mengirim laporan.</strong> Mohon coba lagi.",
                    shareButton: "Bagikan ke WhatsApp",
                    shareText: "Ayo laporkan temuan K3 di sini:"
                },
                'en': {
                    formTitle: "Safety Observation Form (HSE)",
                    reporterInfo: "Reporter Information",
                    observerNameLabel: "Observer Name:",
                    observerCompanyLabel: "Company:",
                    observerPositionLabel: "Position:",
                    obsLocationLabel: "Observation Location:",
                    obsLocationPlaceholder: "Example: Workshop Area, Warehouse B",
                    observationDetails: "Observation Details",
                    obsDateLabel: "Observation Date:",
                    categoriesLabel: "Observation Categories:",
                    catHeights: "Working from Heights",
                    catLifting: "Lifting Operations",
                    catMobile: "Mobile Equipment",
                    catGround: "Ground Disturbance",
                    catDriving: "Driving & Off-Road Vehicles",
                    catMaterial: "Material Handling",
                    catEnergy: "Energy Isolation",
                    catConfined: "Confined Spaces",
                    catElectrical: "Electrical",
                    catNoise: "Noise",
                    catThermal: "Thermal Stress",
                    catHazardous: "Hazardous Materials",
                    catNonHRA: "Non HRA",
                    catOther: "Other",
                    obsTypeLabel: "Observation Type:",
                    safeAct: "Safe Act",
                    unsafeAct: "Unsafe Act",
                    safeCondition: "Safe Condition",
                    unsafeCondition: "Unsafe Condition",
                    descriptionLabel: "Observation Description:",
                    descriptionPlaceholder: "Describe what you observed...",
                    immediateActionLabel: "Immediate Action Taken (If any):",
                    immediateActionPlaceholder: "Example: Reprimanding workers, stopping work, cleaning spills...",
                    recommendationLabel: "Recommendations / Improvement Suggestions:",
                    recommendationPlaceholder: "Example: Re-training needed, install new signs, repair machine...",
                    uploadPhotoLabel: "Upload Photo (Optional):",
                    submitButton: "Submit Report",
                    submittingButton: "Submitting...",
                    successMessage: "<strong>Report successfully submitted!</strong> Thank you for your observation.",
                    errorMessage: "<strong>An error occurred while submitting the report.</strong> Please try again.",
                    shareButton: "Share to WhatsApp",
                    shareText: "Let's report HSE findings here:"
                }
            };

            let currentLang = 'en'; 

            function applyTranslation(lang) {
                document.querySelectorAll('[data-key]').forEach(element => {
                    const key = element.getAttribute('data-key');
                    if (translations[lang][key]) {
                        element.textContent = translations[lang][key];
                    }
                });
                document.querySelectorAll('[data-placeholder-key]').forEach(element => {
                    const key = element.getAttribute('data-placeholder-key');
                    if (translations[lang][key]) {
                        element.placeholder = translations[lang][key];
                    }
                });
                langButtons.forEach(button => {
                    button.classList.remove('active');
                    if (button.dataset.lang === lang) {
                        button.classList.add('active');
                    }
                });
                currentLang = lang;
            }

            langButtons.forEach(button => {
                button.addEventListener('click', function() {
                    const lang = this.dataset.lang;
                    applyTranslation(lang);
                });
            });

            applyTranslation(currentLang);

            function shareViaWhatsApp(data, photoURL) {
                const phoneNumber = "6281285989142";
                let message = `*Laporan Observasi Keselamatan Baru*\n\n`;
                message += `*Nama Observer:* ${data.observerName || 'N/A'}\n`;
                message += `*Perusahaan:* ${data.observerCompany || 'N/A'}\n`;
                message += `*Jabatan:* ${data.observerPosition || 'N/A'}\n`;
                message += `*Lokasi:* ${data.obsLocation || 'N/A'}\n`;
                message += `*Tanggal:* ${data.obsDate || 'N/A'}\n\n`;
                message += `*--- Detail Observasi ---*\n`;
                message += `*Kategori:* ${data.category || 'N/A'}\n`;
                message += `*Jenis:* ${data.obsType || 'N/A'}\n`;
                message += `*Deskripsi:*\n${data.description || 'N/A'}\n\n`;
                message += `*Tindakan Segera:*\n${data.immediateAction || 'N/A'}\n\n`;
                message += `*Rekomendasi:*\n${data.recommendation || 'N/A'}\n\n`;

                if (photoURL) {
                    message += `*Link Foto:* ${photoURL}\n`;
                } else {
                    message += `*Foto:* Tidak ada foto yang dilampirkan.\n`;
                }

                const encodedMessage = encodeURIComponent(message);
                const whatsappUrl = `https://wa.me/${phoneNumber}?text=${encodedMessage}`;
                window.open(whatsappUrl, '_blank');
            }

            safetyForm.addEventListener("submit", async function(event) {
                event.preventDefault();
                const submitAction = event.submitter ? event.submitter.value : 'submit';

                const submitButtons = safetyForm.querySelectorAll('button[type="submit"]');
                submitButtons.forEach(btn => btn.disabled = true);
                
                const originalButton = event.submitter || document.querySelector('.submit-btn');
                const originalButtonText = originalButton.textContent;
                originalButton.textContent = translations[currentLang].submittingButton;
                
                messageDiv.style.display = 'none';

                try {
                    // 1. Save reporter info for next time
                    saveReporterInfo();

                    // 2. Handle File Upload to Cloudinary
                    const fileInput = document.getElementById('uploadPhoto');
                    let file = fileInput.files[0];
                    let photoURL = '';

                    if (file) {
                        console.log(`Original file size: ${file.size / 1024 / 1024} MB`);
                        const options = {
                            maxSizeMB: 1,
                            maxWidthOrHeight: 1920,
                            useWebWorker: true
                        }
                        const compressedFile = await imageCompression(file, options);
                        console.log(`Compressed file size: ${compressedFile.size / 1024 / 1024} MB`);
                        file = compressedFile; // Use the compressed file for upload

                        const cloudName = 'dnk3hccmm';
                        const uploadPreset = 'unsigned_reports';
                        const cloudinaryUrl = `https://api.cloudinary.com/v1_1/${cloudName}/image/upload`;
                        
                        const formData = new FormData();
                        formData.append('file', file);
                        formData.append('upload_preset', uploadPreset);
                        formData.append('folder', 'observationform');

                        const response = await fetch(cloudinaryUrl, {
                            method: 'POST',
                            body: formData
                        });

                        if (!response.ok) {
                            throw new Error('Cloudinary upload failed');
                        }

                        const cloudinaryData = await response.json();
                        photoURL = cloudinaryData.secure_url;
                    }

                    // 3. Prepare data for Firestore
                    const formElementData = new FormData(safetyForm);
                    const dataToSave = {};
                    formElementData.forEach((value, key) => {
                        if (key !== 'uploadPhoto' && key !== 'submitAction') {
                            dataToSave[key] = value;
                        }
                    });
                    dataToSave.photoURL = photoURL;
                    dataToSave.submittedAt = firebase.firestore.FieldValue.serverTimestamp();
                    dataToSave.submittedBy = loggedInUser.email;

                    // 4. Save to Firestore
                    await db.collection("observations").add(dataToSave);

                    // 5. Handle WhatsApp sharing if needed
                    if (submitAction === 'whatsapp') {
                        shareViaWhatsApp(dataToSave, photoURL);
                    }

                    // 6. Success Feedback
                    messageDiv.innerHTML = translations[currentLang].successMessage;
                    messageDiv.className = "form-message success";
                    safetyForm.reset();
                    loadReporterInfo(); 
                    window.scrollTo(0, 0);

                } catch (error) {
                    // 7. Error Feedback
                    console.error("Error submitting report: ", error);
                    messageDiv.innerHTML = translations[currentLang].errorMessage;
                    messageDiv.className = "form-message error";
                } finally {
                    // 8. Reset button state
                    submitButtons.forEach(btn => btn.disabled = false);
                    originalButton.textContent = originalButtonText;
                    setTimeout(() => {
                        messageDiv.style.display = 'none';
                    }, 6000);
                }
            });
            

        });
    </script>
</body>
</html>
