<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="UTF-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1.0" />
		<title>Admin Dashboard</title>
		<link rel="preconnect" href="https://fonts.googleapis.com" />
		<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
		<link
			href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap"
			rel="stylesheet"
		/>
		<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
		<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
		<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.29/jspdf.plugin.autotable.min.js"></script>
		<style>
			body {
				font-family: "Inter", sans-serif;
				padding: 20px;
				background-color: #f4f7f6;
				margin: 0;
			}
			.header {
				display: flex;
				/* justify-content: space-between; */
				align-items: center;
				margin-bottom: 20px;
				position: relative;
				gap: 20px; /* Add gap between logo and title */
			}
			.header-logo {
				height: 50px; /* Adjust as needed */
				width: auto;
				max-width: 100px; /* Ensure it doesn't get too big */
				object-fit: contain;
			}
			.header-controls {
				display: flex;
				align-items: center;
				gap: 20px;
				margin-left: auto; /* Push controls to the right */
			}
			.language-buttons {
				display: flex;
				gap: 10px;
			}
			.language-button {
				cursor: pointer;
				width: 28px;
				height: 28px;
				border-radius: 50%;
				overflow: hidden;
				box-shadow: 0 1px 4px rgba(0, 0, 0, 0.2);
				transition: transform 0.2s ease, box-shadow 0.2s ease;
				border: 2px solid transparent;
			}
			.language-button:hover {
				transform: scale(1.1);
			}
			.language-button.active {
				border-color: #34495e;
			}
			.language-button img {
				width: 100%;
				height: 100%;
				object-fit: cover;
			}
			h1 {
				color: #2c3e50;
			}
			#logout-btn {
				background-color: #e74c3c;
				color: white;
				border: none;
				padding: 10px 15px;
				border-radius: 6px;
				cursor: pointer;
				font-size: 14px;
				font-weight: bold;
				transition: background-color 0.3s ease;
			}
			#logout-btn:hover {
				background-color: #c0392b;
			}

			/* Tab Navigation */
			.tab-nav {
				display: flex;
				border-bottom: 2px solid #dee2e6;
				margin-bottom: 20px;
			}
			.tab-button {
				padding: 10px 20px;
				cursor: pointer;
				border: none;
				background-color: transparent;
				font-size: 16px;
				font-weight: 600;
				color: #495057;
				border-bottom: 2px solid transparent;
				margin-bottom: -2px;
			}
			.tab-button.active {
				color: #007bff;
				border-color: #007bff;
			}
			.tab-content {
				display: none;
			}
			.tab-content.active {
				display: block;
			}

			.dashboard-controls {
				background-color: #fff;
				padding: 20px;
				border-radius: 8px;
				margin-bottom: 20px;
				box-shadow: 0 4px 8px rgba(0, 0, 0, 0.05);
			}
			.filter-container {
				display: flex;
				gap: 20px;
				align-items: center;
				margin-bottom: 20px;
			}
			.filter-group label {
				font-weight: 600;
				margin-right: 10px;
				font-size: 14px;
				color: #555;
			}
			#dateFilter {
				padding: 8px;
				border-radius: 4px;
				border: 1px solid #ccc;
			}
			.charts-container {
				display: grid;
				grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
				gap: 20px;
				padding: 10px 0;
			}
			.chart-box {
				width: 100%;
			}
			table {
				width: 100%;
				border-collapse: collapse;
				background-color: #fff;
				box-shadow: 0 4px 8px rgba(0, 0, 0, 0.05);
				border-radius: 8px;
				overflow: hidden;
			}
			th,
			td {
				padding: 12px 15px;
				text-align: left;
				border-bottom: 1px solid #e0e0e0;
			}
			th {
				background-color: #34495e;
				color: white;
				font-weight: 600;
			}
			tr:nth-child(even) {
				background-color: #f9fafb;
			}
			tr:hover {
				background-color: #f1f1f1;
			}
			.details-btn,
			.approve-btn {
				color: white;
				border: none;
				padding: 8px 12px;
				border-radius: 4px;
				cursor: pointer;
				font-weight: bold;
			}
			.details-btn {
				background-color: #3498db;
			}
			.approve-btn {
				background-color: #2ecc71;
			}
			.approve-btn:disabled {
				background-color: #95a5a6;
				cursor: not-allowed;
			}
			.status-badge {
				padding: 4px 8px;
				border-radius: 12px;
				font-size: 12px;
				font-weight: bold;
				color: white;
			}
			.status-approved {
				background-color: #27ae60;
			}
			.status-pending {
				background-color: #f39c12;
			}
			.status-unverified {
				background-color: #7f8c8d;
			}

			#loading,
			#loading-users {
				text-align: center;
				padding: 20px;
				font-size: 18px;
				color: #7f8c8d;
			}
			.modal-overlay {
				display: none;
				position: fixed;
				z-index: 1000;
				left: 0;
				top: 0;
				width: 100%;
				height: 100%;
				overflow: auto;
				background-color: rgba(0, 0, 0, 0.5);
				justify-content: center;
				align-items: center;
			}
			.modal-content {
				background-color: #fefefe;
				margin: auto;
				padding: 20px;
				border: 1px solid #888;
				width: 80%;
				max-width: 600px;
				border-radius: 8px;
			}
			.modal-close {
				color: #aaa;
				float: right;
				font-size: 28px;
				font-weight: bold;
				cursor: pointer;
			}
			.modal-photo-container {
				width: 200px;
				height: 250px; /* Fixed height */
				border-radius: 8px;
				overflow: hidden; /* This is important for cropping */
				margin-top: 10px;
				border: 1px solid #e0e0e0;
			}
			.modal-photo {
				width: 100%;
				height: 100%;
				object-fit: cover; /* This crops the image to fit */
			}
			.table-img {
				width: 60px;
				height: 60px;
				object-fit: cover;
				border-radius: 4px;
				cursor: pointer;
				display: block;
			}
			.col-desc {
				max-width: 250px;
				white-space: normal;
				word-wrap: break-word;
				overflow-wrap: break-word;
			}
		</style>
	</head>
	<body>
		<div class="header">
			<img
				src="https://res.cloudinary.com/dnk3hccmm/image/upload/v1763541373/lgo1_aipv7n.png"
				alt="Company Logo"
				class="header-logo"
			/>
			<h1 data-key="dashboardTitle">Admin Dashboard</h1>
			<div class="header-controls">
				<button
					id="observation-form-btn"
					style="
						background-color: #3498db;
						color: white;
						border: none;
						padding: 10px 15px;
						border-radius: 6px;
						cursor: pointer;
						font-size: 14px;
						font-weight: bold;
						transition: background-color 0.3s ease;
					"
					data-key="observationFormButton"
				>
					Go to Observation Form
				</button>
				<div class="language-buttons">
					<div class="language-button" id="lang-id" data-lang="id">
						<img src="img/ID.svg" alt="Bahasa Indonesia" />
					</div>
					<div class="language-button active" id="lang-en" data-lang="en">
						<img src="img/EN.svg" alt="English" />
					</div>
				</div>
				<button id="logout-btn" data-key="logoutButton">Logout</button>
			</div>
		</div>

		<div class="tab-nav">
			<button
				class="tab-button active"
				data-tab="observations"
				data-key="tabObservations"
			>
				Observations
			</button>
			<button class="tab-button" data-tab="users" data-key="tabUserManagement">
				User Management
			</button>
		</div>

		<div id="observations-content" class="tab-content active">
			<div class="dashboard-controls">
				<div class="filter-container">
					<div class="filter-group">
						<label for="startDate" data-key="startDateLabel">Start Date:</label>
						<input type="date" id="startDate" />
					</div>
					<div class="filter-group">
						<label for="endDate" data-key="endDateLabel">End Date:</label>
						<input type="date" id="endDate" />
					</div>
					<button id="applyDateFilter" data-key="applyFilterButton">
						Apply Filter
					</button>
					<button id="resetDateFilter" data-key="resetFilterButton">
						Reset
					</button>
					<button
						id="exportPdfBtn"
						data-key="exportPdfButton"
						style="margin-left: auto; background-color: #e67e22; color: white; border: none; padding: 8px 12px; border-radius: 4px; cursor: pointer; font-weight: bold;"
					>
						Export PDF
					</button>
				</div>
				<div class="charts-container">
					<div class="chart-box"><canvas id="positionChart"></canvas></div>
					<div class="chart-box"><canvas id="categoryChart"></canvas></div>
					<div class="chart-box"><canvas id="typeChart"></canvas></div>
				</div>
			</div>
			<div id="table-container">
				<div id="loading" data-key="loading">Loading data...</div>
				<table>
					<thead>
						<tr>
							<th data-key="colName">Name</th>
							<th data-key="colRole">Roles</th>
							<th data-key="colLocation">Location</th>
							<th data-key="colDate">Date</th>
							<th data-key="colObsType">Observation Type</th>
							<th data-key="colObsDesc">Observation Description</th>
							<th data-key="colCategory">Category</th>
							<th data-key="colImage">Image</th>
							<th data-key="colDetail">Detail</th>
						</tr>
					</thead>
					<tbody id="dashboard-content"></tbody>
				</table>
			</div>
		</div>

		<div id="users-content" class="tab-content">
			<div id="loading-users" data-key="loadingUsers">Loading users...</div>
			<table>
				<thead>
					<tr>
						<th data-key="colUserName">Name</th>
						<th data-key="colUserEmail">Email</th>
						<th data-key="colUserRegistered">Registered</th>
						<th data-key="colUserStatus">Status</th>
						<th data-key="colUserActions">Actions</th>
					</tr>
				</thead>
				<tbody id="users-table-content"></tbody>
			</table>
		</div>

		<div id="detailsModal" class="modal-overlay">
			<div class="modal-content">
				<span class="modal-close">&times;</span>
				<div id="modal-body-content" class="modal-body"></div>
			</div>
		</div>

		<!-- Firebase Scripts -->
		<!-- These scripts are now served by Firebase Hosting -->
		<script src="/__/firebase/8.6.1/firebase-app.js"></script>
		<script src="/__/firebase/8.6.1/firebase-auth.js"></script>
		<script src="/__/firebase/8.6.1/firebase-firestore.js"></script>
		<script src="/__/firebase/8.6.1/firebase-storage.js"></script>
		<script src="/__/firebase/8.6.1/firebase-functions.js"></script>
		<script src="/__/firebase/init.js"></script>
		<script src="js/firebase-init.js"></script>

		<script>
			document.addEventListener("DOMContentLoaded", function () {
				// --- AUTH CHECK ---
				const adminUser = JSON.parse(sessionStorage.getItem("adminUser"));
				if (!adminUser) {
					window.location.href = "admin-login.html";
				}

				// --- TRANSLATIONS ---
				const translations = {
					id: {
						dashboardTitle: "Dasbor Admin",
						logoutButton: "Keluar",
						startDateLabel: "Tanggal Mulai:",
						endDateLabel: "Tanggal Akhir:",
						applyFilterButton: "Terapkan Filter",
						resetFilterButton: "Atur Ulang",
						exportPdfButton: "Ekspor PDF",
						loading: "Memuat data...",
						colName: "Nama",
						colRole: "Jabatan",
						colLocation: "Lokasi",
						colDate: "Tanggal",
						colObsType: "Jenis Observasi",
						colObsDesc: "Deskripsi Observasi",
						colCategory: "Kategori",
						colImage: "Foto",
						colDetail: "Detail",
						detailsButton: "Detail",
						noReports: "Tidak ada laporan ditemukan.",
						chartTitlePosition: "Observasi berdasarkan Jabatan",
						chartTitleCategory: "Observasi berdasarkan Kategori",
						chartTitleType: "Observasi berdasarkan Jenis",
						modalTitle: "Detail Observasi",
						modalDate: "Tanggal",
						modalObserver: "Observer",
						modalCompany: "Perusahaan",
						modalPosition: "Jabatan",
						modalLocation: "Lokasi",
						modalHeaderObservation: "Observasi",
						modalCategory: "Kategori",
						modalType: "Jenis",
						modalDescription: "Deskripsi",
						modalHeaderFollowUp: "Tindak Lanjut",
						modalImmediateAction: "Tindakan Segera",
						modalRecommendation: "Rekomendasi",
						modalPhoto: "Foto",
						modalNoPhoto: "Tidak ada foto.",
						tabObservations: "Observasi",
						tabUserManagement: "Manajemen Pengguna",
						loadingUsers: "Memuat pengguna...",
						colUserName: "Nama",
						colUserEmail: "Email",
						colUserRegistered: "Terdaftar",
						colUserStatus: "Status",
						colUserActions: "Aksi",
						approveButton: "Setujui",
						disapproveButton: "Tolak",
						deleteButton: "Hapus",
						statusApproved: "Disetujui",
						statusPending: "Menunggu",
						statusUnverified: "Belum Diverifikasi",
						actionSuccess: "Berhasil!",
						actionError: "Terjadi kesalahan.",
						observationFormButton: "Kembali ke Form Observasi",
						modalPhotoLink: "Lihat Foto",
						modalNoPhotoPlaceholder: "Tidak ada foto dokumentasi.",
					},
					en: {
						dashboardTitle: "Admin Dashboard",
						logoutButton: "Logout",
						startDateLabel: "Start Date:",
						endDateLabel: "End Date:",
						applyFilterButton: "Apply Filter",
						resetFilterButton: "Reset",
						exportPdfButton: "Export PDF",
						loading: "Loading data...",
						colName: "Name",
						colRole: "Roles",
						colLocation: "Location",
						colDate: "Date",
						colObsType: "Observation Type",
						colObsDesc: "Observation Description",
						colCategory: "Category",
						colImage: "Image",
						colDetail: "Detail",
						detailsButton: "Details",
						noReports: "No reports found.",
						chartTitlePosition: "Observations by Position",
						chartTitleCategory: "Observations by Category",
						chartTitleType: "Observations by Type",
						modalTitle: "Observation Details",
						modalDate: "Date",
						modalObserver: "Observer",
						modalCompany: "Company",
						modalPosition: "Position",
						modalLocation: "Location",
						modalHeaderObservation: "Observation",
						modalCategory: "Category",
						modalType: "Type",
						modalDescription: "Description",
						modalHeaderFollowUp: "Follow-up",
						modalImmediateAction: "Immediate Action",
						modalRecommendation: "Recommendation",
						modalPhoto: "Photo",
						modalNoPhoto: "No photo submitted.",
						tabObservations: "Observations",
						tabUserManagement: "User Management",
						loadingUsers: "Loading users...",
						colUserName: "Name",
						colUserEmail: "Email",
						colUserRegistered: "Registered",
						colUserStatus: "Status",
						colUserActions: "Actions",
						approveButton: "Approve",
						statusApproved: "Approved",
						statusPending: "Pending",
						statusUnverified: "Unverified",
						actionSuccess: "Success!",
						actionError: "An error occurred.",
						observationFormButton: "Go to Observation Form",
						modalPhotoLink: "View Photo",
						modalNoPhotoPlaceholder: "No documentation photo provided.",
					},
				};
				let currentLang = "en";

				// --- DOM ELEMENTS ---
				const langButtons = document.querySelectorAll(".language-button");
				const tabButtons = document.querySelectorAll(".tab-button");
				const tabContents = document.querySelectorAll(".tab-content");
				const contentDiv = document.getElementById("dashboard-content");
				const loadingDiv = document.getElementById("loading");
				const modal = document.getElementById("detailsModal");
				const modalBody = document.getElementById("modal-body-content");
				const closeModalBtn = document.querySelector(".modal-close");
				const startDateInput = document.getElementById("startDate");
				const endDateInput = document.getElementById("endDate");
				const applyDateFilterBtn = document.getElementById("applyDateFilter");
				const resetDateFilterBtn = document.getElementById("resetDateFilter");
				const usersTableBody = document.getElementById("users-table-content");
				const loadingUsersDiv = document.getElementById("loading-users");
				const observationFormBtn = document.getElementById(
					"observation-form-btn"
				);

				// --- GLOBAL STATE ---
				let allReports = [];
				let allUsers = [];
				let positionChart, categoryChart, typeChart;
				let currentView = "observations";

				// --- INITIAL SETUP ---
				function setDateFiltersMaxDate() {
					const today = new Date().toISOString().split("T")[0];
					startDateInput.max = today;
					endDateInput.max = today;
				}

				// --- TRANSLATION LOGIC ---
				function applyTranslation(lang) {
					document.querySelectorAll("[data-key]").forEach((el) => {
						const key = el.getAttribute("data-key");
						if (translations[lang][key]) {
							el.textContent = translations[lang][key];
						}
					});
					document.title = lang === "id" ? "Dasbor Admin" : "Admin Dashboard";
					currentLang = lang;
					langButtons.forEach((btn) => {
						btn.classList.remove("active");
						if (btn.dataset.lang === lang) {
							btn.classList.add("active");
						}
					});
					if (currentView === "observations") updateObservationsDashboard();
					else renderUsersTable();
				}

				// --- VIEW SWITCHING ---
				function switchView(view) {
					currentView = view;
					tabContents.forEach((content) => content.classList.remove("active"));
					tabButtons.forEach((button) => button.classList.remove("active"));
					document.getElementById(`${view}-content`).classList.add("active");
					document
						.querySelector(`.tab-button[data-tab="${view}"]`)
						.classList.add("active");
					if (view === "observations") updateObservationsDashboard();
					else if (view === "users") renderUsersTable();
				}

				// --- USER MANAGEMENT ---
				function renderUsersTable() {
					if (allUsers.length === 0) {
						usersTableBody.innerHTML = `<tr><td colspan="5" style="text-align: center;">No users found.</td></tr>`;
						return;
					}
					let html = "";
					allUsers.forEach((user) => {
						const registeredDate = user.createdAt
							? user.createdAt.toDate().toLocaleDateString()
							: "N/A";
						const statusKey = `status${
							user.status.charAt(0).toUpperCase() + user.status.slice(1)
						}`;
						const statusText =
							translations[currentLang][statusKey] || user.status;
						const statusClass = `status-${user.status}`;
						html += `
                        <tr>
                            <td>${user.displayName || "N/A"}</td>
                            <td>${user.email || "N/A"}</td>
                            <td>${registeredDate}</td>
                            <td><span class="status-badge ${statusClass}">${statusText}</span></td>
                            <td>
                                ${
																	user.status !== "approved"
																		? `<button class="approve-btn" data-uid="${user.uid}">${translations[currentLang].approveButton}</button>`
																		: ""
																}
                            </td>
                        </tr>`;
					});
					usersTableBody.innerHTML = html;
				}

				// --- OBSERVATIONS DASHBOARD ---
				function updateObservationsDashboard() {
					const startDate = startDateInput.value;
					const endDate = endDateInput.value;
					let filteredReports = allReports;

					if (startDate && endDate) {
						filteredReports = allReports.filter((report) => {
							if (!report.obsDate) return false;
							return report.obsDate >= startDate && report.obsDate <= endDate;
						});
					}
					renderObservationsTable(filteredReports);
					updatePieChart(
						filteredReports,
						"observerPosition",
						"positionChart",
						translations[currentLang].chartTitlePosition,
						positionChart,
						(c) => (positionChart = c)
					);
					updatePieChart(
						filteredReports,
						"category",
						"categoryChart",
						translations[currentLang].chartTitleCategory,
						categoryChart,
						(c) => (categoryChart = c)
					);
					updatePieChart(
						filteredReports,
						"obsType",
						"typeChart",
						translations[currentLang].chartTitleType,
						typeChart,
						(c) => (typeChart = c)
					);
				}

								function renderObservationsTable(reports) {
					if (reports.length === 0) {
						contentDiv.innerHTML = `<tr><td colspan="9" style="text-align: center;">${translations[currentLang].noReports}</td></tr>`;
						return;
					}

					let html = "";
					reports.forEach((report) => {
						const date =
							report.obsDate ||
							(report.submittedAt
								? report.submittedAt.toDate().toLocaleDateString()
								: "N/A");

						const photoHtml = report.photoURL
							? `<img src="${report.photoURL}" alt="Observation" class="table-img" onclick="window.open('${report.photoURL}', '_blank')">`
							: "No Image";

						html += `
                        <tr>
                            <td>${report.observerName || "N/A"}</td>
                            <td>${report.observerPosition || "N/A"}</td>
                            <td>${report.obsLocation || "N/A"}</td>
                            <td>${date}</td>
                            <td>${report.obsType || "N/A"}</td>
                            <td class="col-desc">${report.description || "N/A"}</td>
                            <td>${report.category || "N/A"}</td>
                            <td>${photoHtml}</td>
                            <td><button class="details-btn" data-id="${
															report.id
														}">${translations[currentLang].detailsButton}</button></td>
                        </tr>`;
					});

					contentDiv.innerHTML = html;
				}

				

								function generateColors(numColors) {

									const colors = [];

									const hueStep = 360 / numColors;

									for (let i = 0; i < numColors; i++) {

										const hue = i * hueStep;

										colors.push(`hsl(${hue}, 70%, 60%)`);

									}

									return colors;

								}

				

								                                function updatePieChart(reports, field, canvasId, title, chartInstance, setChartInstance) {
								                					const totalObservations = reports.length;
								                					const counts = reports.reduce((acc, report) => {
								                						const key = report[field] || "Unknown";
								                						acc[key] = (acc[key] || 0) + 1;
								                						return acc;
								                					}, {});
								                
								                					if (chartInstance) {
								                						chartInstance.destroy();
								                					}
								                
								                					const centerTextPlugin = {
								                						id: 'centerText',
								                						beforeDraw: function(chart) {
								                							if (chart.config.options.plugins.centerText.display) {
								                								const ctx = chart.ctx;
								                								const centerConfig = chart.config.options.plugins.centerText;
								                								const fontWeight = centerConfig.fontWeight || 'normal';
								                								const fontStyle = centerConfig.fontStyle || 'Arial';
								                								const txt = centerConfig.text;
								                								const color = centerConfig.color || '#000';
								                								const maxFontSize = centerConfig.maxFontSize || 75;
								                								const minFontSize = centerConfig.minFontSize || 20;
								                
								                								ctx.save();
								                								let fontSize = (chart.innerRadius / 1.2); // Aggressive font sizing
								                								if (fontSize > maxFontSize) fontSize = maxFontSize;
								                								if (fontSize < minFontSize) fontSize = minFontSize;
								                								
								                								ctx.font = `${fontWeight} ${fontSize}px ${fontStyle}`;
								                								ctx.textBaseline = 'middle';
								                								ctx.textAlign = 'center';
								                
								                								const textX = Math.round((chart.chartArea.left + chart.chartArea.right) / 2);
								                								const textY = Math.round((chart.chartArea.top + chart.chartArea.bottom) / 2);
								                								
								                								ctx.fillStyle = color;
								                								ctx.fillText(txt, textX, textY);
								                								ctx.restore();
								                							}
								                						}
								                					};
								                
								                					const newChart = new Chart(document.getElementById(canvasId), {
								                						type: "doughnut",
								                						data: {
								                							labels: Object.keys(counts),
								                							datasets: [{
								                								data: Object.values(counts),
								                								backgroundColor: generateColors(Object.keys(counts).length),
								                							}],
								                						},
								                						plugins: [centerTextPlugin],
								                						options: {
								                							responsive: true,
								                							plugins: {
								                								legend: {
								                									position: 'top',
								                									labels: {
								                										generateLabels: function(chart) {
								                											const data = chart.data;
								                											if (data.labels.length && data.datasets.length) {
								                																								return data.labels.map((label, i) => {
								                																									const meta = chart.getDatasetMeta(0);
								                																									const ds = data.datasets[0];
								                																									const value = ds.data[i];
								                																									// Attempt to translate the label
								                																									const translatedLabel = translations[currentLang][`cat${label.replace(/\s/g, '')}`] || translations[currentLang][label.replace(/\s/g, '')] || label;
								                																									return {
								                																										text: `${translatedLabel}: ${value}`,
								                																										fillStyle: ds.backgroundColor[i],
								                																										hidden: isNaN(ds.data[i]) || meta.data[i].hidden,
								                																										index: i
								                																									};
								                																								});								                											}
								                											return [];
								                										}
								                									}
								                								},
								                								title: { display: true, text: title },
								                								centerText: {
								                									display: true,
								                									text: totalObservations,
								                									color: '#2c3e50',
								                									fontWeight: 'bold', // Corrected property
								                									fontStyle: 'Arial',
								                									maxFontSize: 70,
								                									minFontSize: 30 
								                								}
								                							}
								                						},
								                					});
								                					setChartInstance(newChart);
								                				}				// --- DATA FETCHING ---
				db.collection("observations")
					.orderBy("obsDate", "desc")
					.onSnapshot(
						(snapshot) => {
							loadingDiv.style.display = "none";
							allReports = snapshot.docs.map((doc) => ({
								id: doc.id,
								...doc.data(),
							}));
							if (currentView === "observations") applyTranslation(currentLang);
						},
						(error) => {
							console.error("Error fetching observations: ", error);
							loadingDiv.textContent = "Error loading data.";
						}
					);

				db.collection("users")
					.where("status", "in", ["approved", "pending", "unverified"])
					.orderBy("createdAt", "desc")
					.onSnapshot(
						(snapshot) => {
							loadingUsersDiv.style.display = "none";
							allUsers = snapshot.docs.map((doc) => ({
								uid: doc.id,
								...doc.data(),
							}));
							if (currentView === "users") applyTranslation(currentLang);
						},
						(error) => {
							console.error("Error fetching users: ", error);
							loadingUsersDiv.textContent = "Error loading users.";
						}
					);

				// --- EVENT LISTENERS ---
				langButtons.forEach((button) =>
					button.addEventListener("click", function () {
						applyTranslation(this.dataset.lang);
					})
				);
				tabButtons.forEach((button) =>
					button.addEventListener("click", function () {
						switchView(this.dataset.tab);
					})
				);
				document.getElementById("logout-btn").addEventListener("click", () => {
					sessionStorage.removeItem("adminUser");
					window.location.href = "admin-login.html";
				});
				applyDateFilterBtn.addEventListener(
					"click",
					updateObservationsDashboard
				);
				resetDateFilterBtn.addEventListener("click", () => {
					startDateInput.value = "";
					endDateInput.value = "";
					updateObservationsDashboard();
				});

				usersTableBody.addEventListener("click", async (e) => {
					if (e.target && e.target.classList.contains("approve-btn")) {
						const button = e.target;
						const uid = button.dataset.uid;
						button.disabled = true;
						try {
							await db
								.collection("users")
								.doc(uid)
								.update({ status: "approved" });
						} catch (error) {
							console.error("Error approving user: ", error);
							button.disabled = false;
							alert(
								`${translations[currentLang].actionError}: ${error.message}`
							);
						}
					}
				});

				contentDiv.addEventListener("click", (e) => {
					if (e.target && e.target.classList.contains("details-btn")) {
						const reportId = e.target.dataset.id;
						const report = allReports.find((r) => r.id === reportId);
						if (report) showDetailsModal(report);
					}
				});

				closeModalBtn.onclick = () => (modal.style.display = "none");
				window.onclick = (event) => {
					if (event.target == modal) modal.style.display = "none";
				};

				function showDetailsModal(report) {
					const date =
						report.obsDate ||
						(report.submittedAt
							? report.submittedAt.toDate().toLocaleDateString()
							: "N/A");
					let photoContent = `<p><strong data-key="modalPhoto">Photo:</strong> ${translations[currentLang].modalNoPhoto}</p>`;
					if (report.photoURL) {
						photoContent = `
							<p><strong data-key="modalPhoto">Photo:</strong></p>
							<div class="modal-photo-container">
								<img src="${report.photoURL}" alt="Observation Photo" class="modal-photo">
							</div>
						`;
					}
					modalBody.innerHTML = `
						<h2>${translations[currentLang].modalTitle}</h2>
						<p><strong>${translations[currentLang].modalDate}:</strong> ${date}</p>
						<p><strong>${translations[currentLang].modalObserver}:</strong> ${
						report.observerName || "N/A"
					}</p>
						<p><strong>${translations[currentLang].modalCompany}:</strong> ${
						report.observerCompany || "N/A"
					}</p>
						<p><strong>${translations[currentLang].modalPosition}:</strong> ${
						report.observerPosition || "N/A"
					}</p>
						<p><strong>${translations[currentLang].modalLocation}:</strong> ${
						report.obsLocation || "N/A"
					}</p>
						<h3>${translations[currentLang].modalHeaderObservation}</h3>
						<p><strong>${translations[currentLang].modalCategory}:</strong> ${
						report.category || "N/A"
					}</p>
						<p><strong>${translations[currentLang].modalType}:</strong> ${
						report.obsType || "N/A"
					}</p>
						<p><strong>${translations[currentLang].modalDescription}:</strong> ${
						report.description || "N/A"
					}</p>
						<h3>${translations[currentLang].modalHeaderFollowUp}</h3>
						<p><strong>${translations[currentLang].modalImmediateAction}:</strong> ${
						report.immediateAction || "N/A"
					}</p>
						<p><strong>${translations[currentLang].modalRecommendation}:</strong> ${
						report.recommendation || "N/A"
					}</p>
						${photoContent}`;
					modal.style.display = "flex";
				}

				// --- INITIAL LOAD ---
				setDateFiltersMaxDate();
				applyTranslation(currentLang);
				observationFormBtn.addEventListener("click", () => {
					window.location.href = "index.html";
				});

				// --- PDF EXPORT LOGIC ---
				document.getElementById("exportPdfBtn").addEventListener("click", exportToPDF);

				async function exportToPDF() {
					const btn = document.getElementById("exportPdfBtn");
					const originalText = btn.textContent;
					btn.textContent = "Processing Images...";
					btn.disabled = true;

					try {
						const { jsPDF } = window.jspdf;
						const doc = new jsPDF("l", "mm", "a4"); // Landscape
						const pageWidth = doc.internal.pageSize.getWidth();
						const pageHeight = doc.internal.pageSize.getHeight();
						const margin = 14;

						const startDate = startDateInput.value || "All Time";
						const endDate = endDateInput.value || "All Time";
						const timestamp = new Date().toLocaleString();

						// --- HELPER: HEADER & FOOTER ---
						const addHeaderFooter = (data) => {
							// Header
							doc.setFontSize(16);
							doc.setFont("helvetica", "bold");
							doc.text("JKT 09 GOLDEN HOURS OBSERVATION", pageWidth / 2, 15, { align: "center" });
							
							doc.setFontSize(10);
							doc.setFont("helvetica", "normal");
							doc.text(`Period: ${startDate} to ${endDate}`, pageWidth / 2, 21, { align: "center" });
							
							// Footer
							doc.setFontSize(8);
							doc.setFont("helvetica", "normal");
							const pageCount = doc.internal.getNumberOfPages();
							const adminEmail = adminUser ? (adminUser.email || "Admin") : "System";
							doc.text(`Exported at: ${timestamp} | By: ${adminEmail}`, margin, pageHeight - 10);
							doc.text(`Page ${pageCount}`, pageWidth - margin, pageHeight - 10, { align: "right" });
						};

						// --- HELPER: FETCH IMAGE AS BASE64 ---
						const getBase64ImageFromUrl = async (imageUrl) => {
							try {
								const res = await fetch(imageUrl);
								const blob = await res.blob();
								return new Promise((resolve, reject) => {
									const reader = new FileReader();
									reader.onloadend = () => resolve(reader.result);
									reader.onerror = reject;
									reader.readAsDataURL(blob);
								});
							} catch (error) {
								console.error("Error converting image:", error);
								return null;
							}
						};

						// --- PAGE 1: CHARTS ---
						addHeaderFooter();
						
						// doc.setFontSize(12);
						// doc.text(`Filter Period: ${startDate} to ${endDate}`, margin, 25);

						try {
							const chart1 = document.getElementById("positionChart");
							const chart2 = document.getElementById("categoryChart");
							const chart3 = document.getElementById("typeChart");

							if (chart1 && chart2 && chart3) {
								const img1 = chart1.toDataURL("image/png");
								const img2 = chart2.toDataURL("image/png");
								const img3 = chart3.toDataURL("image/png");

								// Layout: 3 charts side-by-side
								const chartY = 35;
								const chartWidth = 85;
								const chartHeight = 85;

								doc.addImage(img1, "PNG", margin, chartY, chartWidth, chartHeight);
								doc.addImage(img2, "PNG", margin + chartWidth + 5, chartY, chartWidth, chartHeight);
								doc.addImage(img3, "PNG", margin + (chartWidth * 2) + 10, chartY, chartWidth, chartHeight);
							}
						} catch (err) {
							console.error("Error adding charts to PDF:", err);
							doc.text("Error rendering charts.", margin, 40);
						}

						// --- PAGE 2: TABLE ---
						doc.addPage(); // Start table on new page

						const tableHead = [
							[
								"No",
								"Date",
								"Observer Name",
								"Role",
								"Location",
								"Type",
								"Description",
								"Category",
								"Image"
							]
						];

						// Filter Logic
						let reportsToExport = allReports;
						if (startDateInput.value && endDateInput.value) {
							reportsToExport = allReports.filter((report) => {
								if (!report.obsDate) return false;
								return report.obsDate >= startDateInput.value && report.obsDate <= endDateInput.value;
							});
						}

						// Pre-process body data (Fetch images)
						const tableBody = await Promise.all(reportsToExport.map(async (report, index) => {
							const date = report.obsDate || (report.submittedAt ? report.submittedAt.toDate().toLocaleDateString() : "N/A");
							
							let imageBase64 = null;
							if (report.photoURL) {
								imageBase64 = await getBase64ImageFromUrl(report.photoURL);
							}

							return [
								index + 1, // Row Number
								date,
								report.observerName || "N/A",
								report.observerPosition || "N/A",
								report.obsLocation || "N/A",
								report.obsType || "N/A",
								report.description || "N/A",
								report.category || "N/A",
								imageBase64 // This will be the Base64 string or null
							];
						}));

						doc.autoTable({
							head: tableHead,
							body: tableBody,
							startY: 25,
							margin: { top: 25, bottom: 15, left: margin, right: margin },
							styles: { fontSize: 8, cellPadding: 2, valign: 'middle' },
							columnStyles: {
								0: { cellWidth: 10 }, // No
								6: { cellWidth: 50 }, // Description
								8: { cellWidth: 20 }  // Image column width
							},
							bodyStyles: { minCellHeight: 15 }, // Smaller row height
							rowPageBreak: 'avoid', // Avoid splitting rows
							didDrawPage: function (data) {
								addHeaderFooter();
							},
							didParseCell: function(data) {
								// Check Image Column (Index 8)
								if (data.section === 'body' && data.column.index === 8) {
									if (data.cell.raw) {
										// Has image data -> Clear text to prevent dump
										data.cell.text = "";
									} else {
										// No image data -> Show "No Image" text
										data.cell.text = "No Image";
									}
								}
							},
							didDrawCell: function(data) {
								// Draw Image in the Image Column (Index 8)
								if (data.section === 'body' && data.column.index === 8 && data.cell.raw) {
									const imgData = data.cell.raw; // This is the Base64 string
									if (imgData) {
										const dim = 12; // Smaller Image dimension (12mm)
										// Center image in cell
										const x = data.cell.x + (data.cell.width - dim) / 2;
										const y = data.cell.y + (data.cell.height - dim) / 2;
										try {
											doc.addImage(imgData, x, y, dim, dim);
										} catch (e) {
											console.warn("Failed to draw image", e);
										}
									}
								}
							}
						});

						doc.save(`Observation_Report_${new Date().toISOString().slice(0, 10)}.pdf`);

					} catch (error) {
						console.error("Export failed:", error);
						alert("Failed to export PDF. Check console for details.");
					} finally {
						btn.textContent = originalText;
						btn.disabled = false;
					}
				}
			});
		</script>
	</body>
</html>
