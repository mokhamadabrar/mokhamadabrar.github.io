<!doctype html>
<html lang="en">
	<head>
		<meta charset="UTF-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1.0" />
		<title>Admin Dashboard</title>
		<link rel="preconnect" href="https://fonts.googleapis.com" />
		<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
		<link
			href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap"
			rel="stylesheet"
		/>
		<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
		<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
		<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.29/jspdf.plugin.autotable.min.js"></script>
		<style>
			body {
				font-family: "Inter", sans-serif;
				padding: 20px;
				background-color: #f4f7f6;
				margin: 0;
			}
			.header {
				display: flex;
				/* justify-content: space-between; */
				align-items: center;
				margin-bottom: 20px;
				position: relative;
				gap: 20px; /* Add gap between logo and title */
			}
			.header-logo {
				height: 50px; /* Adjust as needed */
				width: auto;
				max-width: 100px; /* Ensure it doesn't get too big */
				object-fit: contain;
			}
			.header-controls {
				display: flex;
				align-items: center;
				gap: 20px;
				margin-left: auto; /* Push controls to the right */
			}
			.language-buttons {
				display: flex;
				gap: 10px;
			}
			.language-button {
				cursor: pointer;
				width: 28px;
				height: 28px;
				border-radius: 50%;
				overflow: hidden;
				box-shadow: 0 1px 4px rgba(0, 0, 0, 0.2);
				transition:
					transform 0.2s ease,
					box-shadow 0.2s ease;
				border: 2px solid transparent;
			}
			.language-button:hover {
				transform: scale(1.1);
			}
			.language-button.active {
				border-color: #34495e;
			}
			.language-button img {
				width: 100%;
				height: 100%;
				object-fit: cover;
			}
			h1 {
				color: #2c3e50;
			}
			#logout-btn {
				background-color: #e74c3c;
				color: white;
				border: none;
				padding: 10px 15px;
				border-radius: 6px;
				cursor: pointer;
				font-size: 14px;
				font-weight: bold;
				transition: background-color 0.3s ease;
			}
			#logout-btn:hover {
				background-color: #c0392b;
			}

			/* Modern Form Styles */
			input[type="text"],
			input[type="email"],
			select {
				width: 100%;
				padding: 10px 12px;
				border: 1px solid #dfe6e9;
				border-radius: 6px;
				box-sizing: border-box;
				font-size: 15px;
				background-color: #fdfdfd;
				transition:
					border-color 0.3s ease,
					box-shadow 0.3s ease;
				margin-top: 5px;
			}

			input[type="text"]:focus,
			input[type="email"]:focus,
			select:focus {
				border-color: #007bff;
				box-shadow: 0 0 0 3px rgba(0, 123, 255, 0.15);
				outline: none;
			}

			/* Tab Navigation */
			.tab-nav {
				display: flex;
				border-bottom: 2px solid #dee2e6;
				margin-bottom: 20px;
			}
			.tab-button {
				padding: 10px 20px;
				cursor: pointer;
				border: none;
				background-color: transparent;
				font-size: 16px;
				font-weight: 600;
				color: #495057;
				border-bottom: 2px solid transparent;
				margin-bottom: -2px;
			}
			.tab-button.active {
				color: #007bff;
				border-color: #007bff;
			}
			.tab-content {
				display: none;
			}
			.tab-content.active {
				display: block;
			}

			.dashboard-controls {
				background-color: #fff;
				padding: 20px;
				border-radius: 8px;
				margin-bottom: 20px;
				box-shadow: 0 4px 8px rgba(0, 0, 0, 0.05);
			}
			.filter-container {
				display: flex;
				gap: 15px;
				align-items: flex-end; /* Align to bottom so labels don't mess up button alignment */
				margin-bottom: 25px;
				flex-wrap: wrap; /* Allow wrapping on smaller screens */
			}
			.filter-group {
				display: flex;
				flex-direction: column;
				gap: 5px;
			}
			.filter-group label {
				font-weight: 600;
				font-size: 13px;
				color: #546e7a;
				text-transform: uppercase;
				letter-spacing: 0.5px;
			}
			/* Modern Date Input Style */
			input[type="date"] {
				padding: 10px 12px;
				border: 1px solid #cfd8dc;
				border-radius: 6px;
				font-size: 14px;
				color: #37474f;
				background-color: #fff;
				font-family: "Inter", sans-serif;
				transition: all 0.2s ease;
				outline: none;
				min-width: 150px;
			}
			input[type="date"]:focus {
				border-color: #3498db;
				box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.1);
			}
			input[type="date"]::-webkit-calendar-picker-indicator {
				cursor: pointer;
				opacity: 0.6;
				transition: 0.2s;
			}
			input[type="date"]::-webkit-calendar-picker-indicator:hover {
				opacity: 1;
			}

			/* Modern Filter Buttons */
			.btn-filter {
				padding: 10px 18px;
				border: none;
				border-radius: 6px;
				cursor: pointer;
				font-size: 14px;
				font-weight: 600;
				transition: all 0.2s ease;
				display: inline-flex;
				align-items: center;
				justify-content: center;
				height: 42px; /* Match input height roughly */
				box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
			}
			.btn-filter:hover {
				transform: translateY(-1px);
				box-shadow: 0 4px 6px rgba(0, 0, 0, 0.08);
			}
			.btn-filter:active {
				transform: translateY(0);
				box-shadow: none;
			}
			#applyDateFilter {
				background-color: #3498db;
				color: white;
			}
			#applyDateFilter:hover {
				background-color: #2980b9;
			}
			#todayDateFilter {
				background-color: #9b59b6;
				color: white;
			}
			#todayDateFilter:hover {
				background-color: #8e44ad;
			}
			#resetDateFilter {
				background-color: #ecf0f1;
				color: #7f8c8d;
				border: 1px solid #bdc3c7;
			}
			#resetDateFilter:hover {
				background-color: #dfe6e9;
				color: #2c3e50;
			}
			/* Export Buttons Styles reuse */
			.btn-export {
				padding: 8px 15px;
				border-radius: 6px;
				border: none;
				color: white;
				font-weight: 600;
				font-size: 13px;
				cursor: pointer;
				transition: background 0.2s;
				box-shadow: 0 2px 4px rgba(0,0,0,0.1);
				height: 38px;
				display: inline-flex;
				align-items: center;
			}
			#exportPdfBtn {
				background-color: #e67e22;
			}
			#exportPdfBtn:hover {
				background-color: #d35400;
			}
			#exportCsvBtn {
				background-color: #27ae60;
			}
			#exportCsvBtn:hover {
				background-color: #219150;
			}
			.dashboard-grid {
				display: flex;
				gap: 20px;
				padding: 10px 0;
				align-items: stretch; /* Make columns equal height */
			}
			.chart-col-left {
				flex: 3; /* Wider column for Bar Chart */
				display: flex;
				flex-direction: column;
			}
									.chart-col-right {
										flex: 1; /* Narrower column for Pie Charts */
										display: flex;
										flex-direction: column;
										gap: 20px;
										min-width: 350px; /* Ensure pie charts aren't too squashed */
									}
									.chart-box {
										width: 100%;
										display: flex;
										flex-direction: column; /* Changed to column to allow canvas to grow */
										align-items: center;
										background: #fff;
										padding: 15px;
										border-radius: 8px;
										box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
										flex: 1; /* Expand to fill parent */
										min-height: 0; /* Allow flex shrinking if needed */
									}
									.chart-col-left .chart-box {
										flex-direction: column; /* Bar chart stack */
									}
									.chart-col-right .chart-box {
										/* flex-direction: row;  Removed to allow vertical stretch */
									}
									.chart-canvas-container {
										flex: 1;
										position: relative;
										width: 100%;
										min-height: 200px; /* Reduced base min-height */
									}
															/* Specific height override for the left bar chart to ensure it's tall enough */
															.chart-col-left .chart-canvas-container {
																min-height: 400px; 
															}
															.chart-row {
				display: flex;
				gap: 10px;
				width: 100%;
			}
			.chart-legend {
				width: 180px;
				max-height: 300px;
				overflow-y: auto;
				padding-left: 15px;
				font-size: 12px;
			}
			.legend-item {
				display: flex;
				align-items: center;
				margin-bottom: 8px;
				cursor: pointer;
				opacity: 1;
				transition: opacity 0.2s;
			}
			.legend-item.hidden {
				opacity: 0.5;
				text-decoration: line-through;
			}
			.legend-color {
				width: 12px;
				height: 12px;
				min-width: 12px;
				margin-right: 8px;
				border-radius: 2px;
			}
			canvas {
				width: 100% !important;
				height: 100% !important;
			}
			table {
				width: 100%;
				border-collapse: collapse;
				background-color: #fff;
				box-shadow: 0 4px 8px rgba(0, 0, 0, 0.05);
				border-radius: 8px;
				overflow: hidden;
			}
			th,
			td {
				padding: 12px 15px;
				text-align: left;
				border-bottom: 1px solid #e0e0e0;
			}
			th {
				background-color: #34495e;
				color: white;
				font-weight: 600;
			}
			tr:nth-child(even) {
				background-color: #f9fafb;
			}
			tr:hover {
				background-color: #f1f1f1;
			}
			.details-btn,
			.approve-btn {
				color: white;
				border: none;
				padding: 8px 12px;
				border-radius: 4px;
				cursor: pointer;
				font-weight: bold;
			}
			.details-btn {
				background-color: #3498db;
			}
			.approve-btn {
				background-color: #2ecc71;
			}
			.approve-btn:disabled {
				background-color: #95a5a6;
				cursor: not-allowed;
			}
			.status-badge {
				padding: 4px 8px;
				border-radius: 12px;
				font-size: 12px;
				font-weight: bold;
				color: white;
			}
			.status-approved {
				background-color: #27ae60;
			}
			.status-pending {
				background-color: #f39c12;
			}
			.status-unverified {
				background-color: #7f8c8d;
			}

			#loading,
			#loading-users {
				text-align: center;
				padding: 20px;
				font-size: 18px;
				color: #7f8c8d;
			}
			.modal-overlay {
				display: none;
				position: fixed;
				z-index: 1000;
				left: 0;
				top: 0;
				width: 100%;
				height: 100%;
				overflow: auto;
				background-color: rgba(0, 0, 0, 0.5);
				justify-content: center;
				align-items: center;
			}
			.modal-content {
				background-color: #fefefe;
				margin: auto;
				padding: 20px;
				border: 1px solid #888;
				width: 80%;
				max-width: 600px;
				border-radius: 8px;
			}
			.modal-close {
				color: #aaa;
				float: right;
				font-size: 28px;
				font-weight: bold;
				cursor: pointer;
			}
			.modal-photo-container {
				width: 200px;
				height: 250px; /* Fixed height */
				border-radius: 8px;
				overflow: hidden; /* This is important for cropping */
				margin-top: 10px;
				border: 1px solid #e0e0e0;
			}
			.modal-photo {
				width: 100%;
				height: 100%;
				object-fit: cover; /* This crops the image to fit */
			}
			.table-img {
				width: 60px;
				height: 60px;
				object-fit: cover;
				border-radius: 4px;
				cursor: pointer;
				display: block;
			}
			.col-desc {
				max-width: 250px;
				white-space: normal;
				word-wrap: break-word;
				overflow-wrap: break-word;
			}
			/* Mobile Responsiveness */
			@media (max-width: 900px) {
				.header {
					flex-direction: column;
					gap: 15px;
				}
				.header-controls {
					width: 100%;
					justify-content: center;
					margin-left: 0;
					flex-wrap: wrap;
				}
				.filter-container {
					flex-direction: column;
					align-items: stretch;
				}
				.filter-container button {
					margin-left: 0 !important;
					width: 100%;
					margin-top: 10px;
				}
				.dashboard-grid {
					flex-direction: column;
				}
				.chart-col-left,
				.chart-col-right {
					width: 100%;
					flex: none;
					min-width: 0;
				}
				.chart-row {
					flex-direction: column;
				}
				.pie-chart-wrapper {
					flex-direction: column !important;
					text-align: center;
				}
				.chart-legend {
					width: 100%;
					padding-left: 0;
					margin-top: 15px;
					display: flex;
					flex-wrap: wrap;
					justify-content: center;
					gap: 10px;
					max-height: none;
				}
				.chart-col-left .chart-canvas-container {
					min-height: 300px;
				}
				#table-container {
					overflow-x: auto;
				}
				.modal-content {
					width: 95%;
					margin: 10% auto;
				}
				.modal-photo-container {
					width: 100%;
					height: auto;
					max-height: 300px;
				}
			}
		</style>
	</head>
	<body>
		<div class="header">
			<img src="img/logo.webp" alt="Company Logo" class="header-logo" />
			<h1 data-key="dashboardTitle">Admin Dashboard</h1>
			<div class="header-controls">
				<button
					id="observation-form-btn"
					style="
						background-color: #3498db;
						color: white;
						border: none;
						padding: 10px 15px;
						border-radius: 6px;
						cursor: pointer;
						font-size: 14px;
						font-weight: bold;
						transition: background-color 0.3s ease;
					"
					data-key="observationFormButton"
				>
					Go to Observation Form
				</button>
				<div class="language-buttons">
					<div class="language-button" id="lang-id" data-lang="id">
						<img src="img/ID.svg" alt="Bahasa Indonesia" />
					</div>
					<div class="language-button active" id="lang-en" data-lang="en">
						<img src="img/EN.svg" alt="English" />
					</div>
				</div>
				<button id="logout-btn" data-key="logoutButton">Logout</button>
			</div>
		</div>

		<div class="tab-nav">
			<button
				class="tab-button active"
				data-tab="observations"
				data-key="tabObservations"
			>
				Observations
			</button>
			<button class="tab-button" data-tab="users" data-key="tabUserManagement">
				User Management
			</button>
		</div>

		<div id="observations-content" class="tab-content active">
			<div class="dashboard-controls">
				<div class="filter-container">
					<div class="filter-group">
						<label for="startDate" data-key="startDateLabel">Start Date:</label>
						<input type="date" id="startDate" />
					</div>
					<div class="filter-group">
						<label for="endDate" data-key="endDateLabel">End Date:</label>
						<input type="date" id="endDate" />
					</div>
					<button id="applyDateFilter" class="btn-filter" data-key="applyFilterButton">
						Apply Filter
					</button>
					<button id="todayDateFilter" class="btn-filter" data-key="todayFilterButton">
						Today
					</button>
					<button id="resetDateFilter" class="btn-filter" data-key="resetFilterButton">
						Reset
					</button>
					<button
						id="exportPdfBtn"
						class="btn-export"
						data-key="exportPdfButton"
						style="margin-left: auto;"
					>
						Export PDF
					</button>
					<button
						id="exportCsvBtn"
						class="btn-export"
						style="margin-left: 10px;"
					>
						Export CSV
					</button>
				</div>
				<div class="dashboard-grid">
					<div class="chart-col-left">
						<div class="chart-row">
							<div class="chart-box" style="flex: 1; min-width: 0">
								<div class="chart-canvas-container">
									<canvas id="hraChart"></canvas>
								</div>
							</div>
							<div class="chart-box" style="flex: 1; min-width: 0">
								<div class="chart-canvas-container">
									<canvas id="nonHraChart"></canvas>
								</div>
							</div>
						</div>
					</div>
					<div class="chart-col-right">
						<div class="chart-box">
							<div class="pie-chart-wrapper" style="display: flex; width: 100%; flex: 1; align-items: center;">
								<div class="chart-canvas-container">
									<canvas id="positionChart"></canvas>
								</div>
								<div id="positionLegend" class="chart-legend"></div>
							</div>
						</div>
						<div class="chart-box">
							<div class="pie-chart-wrapper" style="display: flex; width: 100%; flex: 1; align-items: center;">
								<div class="chart-canvas-container">
									<canvas id="typeChart"></canvas>
								</div>
								<div id="typeLegend" class="chart-legend"></div>
							</div>
						</div>
					</div>
				</div>
			</div>
			<div id="table-container">
				<div id="loading" data-key="loading">Loading data...</div>
				<table>
					<thead>
						<tr>
							<th data-key="colName">Name</th>
							<th data-key="colRole">Roles</th>
							<th data-key="colLocation">Location</th>
							<th data-key="colDate">Date</th>
							<th data-key="colTime">Time</th>
							<th data-key="colObsType">Observation Type</th>
							<th data-key="colObsDesc">Observation Description</th>
							<th data-key="colCategory">Category</th>
							<th data-key="colImage">Image</th>
							<th data-key="colDetail">Detail</th>
						</tr>
					</thead>
					<tbody id="dashboard-content"></tbody>
				</table>
			</div>
		</div>

		<div id="users-content" class="tab-content">
			<div id="loading-users" data-key="loadingUsers">Loading users...</div>
			<table>
				<thead>
					<tr>
						<th data-key="colUserName">Name</th>
						<th data-key="colUserEmail">Email</th>
						<th data-key="colUserRegistered">Registered</th>
						<th data-key="colUserStatus">Status</th>
						<th data-key="colUserActions">Actions</th>
					</tr>
				</thead>
				<tbody id="users-table-content"></tbody>
			</table>
		</div>

		<div id="detailsModal" class="modal-overlay">
			<div class="modal-content">
				<span class="modal-close">&times;</span>
				<div id="modal-body-content" class="modal-body"></div>
			</div>
		</div>

		<div id="edit-user-modal-container"></div>

		<!-- Firebase Scripts -->
		<!-- These scripts are now served by Firebase Hosting -->
		<script src="/__/firebase/8.6.1/firebase-app.js"></script>
		<script src="/__/firebase/8.6.1/firebase-auth.js"></script>
		<script src="/__/firebase/8.6.1/firebase-firestore.js"></script>
		<script src="/__/firebase/8.6.1/firebase-storage.js"></script>
		<script src="/__/firebase/init.js"></script>
		<script src="js/firebase-init.js"></script>
		<script src="js/translations.js"></script>

		<script>
			document.addEventListener("DOMContentLoaded", function () {
				// ... (previous code) ...

				// --- AUTH CHECK ---
				const adminUser = JSON.parse(sessionStorage.getItem("adminUser"));
				if (!adminUser) {
					window.location.href = "admin-login.html";
				}

				// --- TRANSLATIONS ---
				let currentLang = "en";

				// --- DOM ELEMENTS ---
				const langButtons = document.querySelectorAll(".language-button");
				const tabButtons = document.querySelectorAll(".tab-button");
				const tabContents = document.querySelectorAll(".tab-content");
				const contentDiv = document.getElementById("dashboard-content");
				const loadingDiv = document.getElementById("loading");
				const modal = document.getElementById("detailsModal");
				const modalBody = document.getElementById("modal-body-content");
				const closeModalBtn = document.querySelector(".modal-close");

				// Edit Modal Variables (initialized after fetch)
				let editUserModal, editUserCloseBtn, editUserCancelBtn, editUserForm;
				let saveUserConfirmModal, confirmSaveYesBtn, confirmSaveNoBtn;

				const startDateInput = document.getElementById("startDate");
				const endDateInput = document.getElementById("endDate");
				const applyDateFilterBtn = document.getElementById("applyDateFilter");
				const resetDateFilterBtn = document.getElementById("resetDateFilter");
				const usersTableBody = document.getElementById("users-table-content");
				const loadingUsersDiv = document.getElementById("loading-users");
				const observationFormBtn = document.getElementById(
					"observation-form-btn",
				);

				// --- DYNAMIC MODAL LOADING ---
				fetch("edit-user-modal.html")
					.then((response) => response.text())
					.then((html) => {
						document.getElementById("edit-user-modal-container").innerHTML =
							html;
						initializeEditUserModal();
						applyTranslation(currentLang);
					})
					.catch((err) =>
						console.error("Failed to load edit user modal:", err),
					);

				function initializeEditUserModal() {
					editUserModal = document.getElementById("editUserModal");
					editUserCloseBtn = editUserModal
						? editUserModal.querySelector(".modal-close")
						: null;
					editUserCancelBtn = document.getElementById("editUserCancelBtn");
					editUserForm = document.getElementById("editUserForm");
					saveUserConfirmModal = document.getElementById(
						"saveUserConfirmModal",
					);
					confirmSaveYesBtn = document.getElementById("confirmSaveYesBtn");
					confirmSaveNoBtn = document.getElementById("confirmSaveNoBtn");

					// Event Listeners for Edit Modal
					if (editUserCloseBtn)
						editUserCloseBtn.onclick = () =>
							(editUserModal.style.display = "none");
					if (editUserCancelBtn)
						editUserCancelBtn.onclick = () =>
							(editUserModal.style.display = "none");
					if (editUserForm) editUserForm.onsubmit = window.initiateSaveUser;

					if (confirmSaveNoBtn)
						confirmSaveNoBtn.onclick = () =>
							(saveUserConfirmModal.style.display = "none");
					if (confirmSaveYesBtn)
						confirmSaveYesBtn.onclick = window.confirmSaveUser;

					// Update global window onclick to include new modals
					const existingOnclick = window.onclick;
					window.onclick = (event) => {
						if (existingOnclick) existingOnclick(event);
						if (editUserModal && event.target == editUserModal)
							editUserModal.style.display = "none";
						if (saveUserConfirmModal && event.target == saveUserConfirmModal)
							saveUserConfirmModal.style.display = "none";
					};
				}

				// --- GLOBAL STATE ---
				let allReports = [];
				let allUsers = [];
				let positionChart, hraChart, nonHraChart, typeChart;
				let currentView = "observations";
				let userEditingId = null; // Track which user is being edited

				// --- INITIAL SETUP ---
				function getLocalToday() {
					const now = new Date();
					const offset = now.getTimezoneOffset();
					const localDate = new Date(now.getTime() - offset * 60 * 1000);
					return localDate.toISOString().split("T")[0];
				}

				function setDateFiltersMaxDate() {
					const today = getLocalToday();
					startDateInput.max = today;
					endDateInput.max = today;
				}

				// --- TRANSLATION LOGIC ---
				function applyTranslation(lang) {
					document.querySelectorAll("[data-key]").forEach((el) => {
						const key = el.getAttribute("data-key");
						if (translations[lang][key]) {
							el.textContent = translations[lang][key];
						}
					});
					document.title = lang === "id" ? "Dasbor Admin" : "Admin Dashboard";
					currentLang = lang;
					langButtons.forEach((btn) => {
						btn.classList.remove("active");
						if (btn.dataset.lang === lang) {
							btn.classList.add("active");
						}
					});
					if (currentView === "observations") updateObservationsDashboard();
					else renderUsersTable();
				}

				// --- VIEW SWITCHING ---
				function switchView(view) {
					currentView = view;
					tabContents.forEach((content) => content.classList.remove("active"));
					tabButtons.forEach((button) => button.classList.remove("active"));
					document.getElementById(`${view}-content`).classList.add("active");
					document
						.querySelector(`.tab-button[data-tab="${view}"]`)
						.classList.add("active");
					if (view === "observations") updateObservationsDashboard();
					else if (view === "users") renderUsersTable();
				}

				// --- USER MANAGEMENT ---

				function renderUsersTable() {
					const adminUser = JSON.parse(sessionStorage.getItem("adminUser"));
					const isSuperAdmin = adminUser && adminUser.role === "superadmin";

					// Clean up any previously added Role headers if they exist from old logic
					const headerRow = document.querySelector("#users-content thead tr");
					const roleHeader = headerRow.querySelector(".col-role-header");
					if (roleHeader) roleHeader.remove();

					// Filter users based on role
					let usersToDisplay = allUsers;
					if (!isSuperAdmin) {
						usersToDisplay = allUsers.filter(
							(u) => u.role !== "admin" && u.role !== "superadmin",
						);
					}

					if (usersToDisplay.length === 0) {
						usersTableBody.innerHTML = `<tr><td colspan="5" style="text-align: center;">No users found.</td></tr>`;
						return;
					}

					let html = "";
					usersToDisplay.forEach((user) => {
						const registeredDate = user.createdAt
							? user.createdAt.toDate().toLocaleDateString() +
								" " +
								user.createdAt.toDate().toLocaleTimeString()
							: "N/A";

						const statusKey = `status${
							user.status.charAt(0).toUpperCase() + user.status.slice(1)
						}`;
						const statusText =
							translations[currentLang][statusKey] || user.status;
						const statusClass = `status-${user.status}`;

						html += `
                        <tr>
                            <td>${user.displayName || "N/A"}</td>
                            <td>${user.email || "N/A"}</td>
                            <td>${registeredDate}</td>
                            <td><span class="status-badge ${statusClass}">${statusText}</span></td>
                            <td>
								<div style="display: flex; gap: 5px;">
                                ${
																	user.status !== "approved"
																		? `<button class="approve-btn" data-uid="${user.uid}">${translations[currentLang].approveButton}</button>`
																		: ""
																}
								<button class="details-btn edit-user-btn" data-uid="${user.uid}">${translations[currentLang].editButton}</button>
								</div>
                            </td>
                        </tr>`;
					});
					usersTableBody.innerHTML = html;
				}

				// Open Edit Modal
				window.openEditUserModal = function (uid) {
					const user = allUsers.find((u) => u.uid === uid);
					if (!user) return;

					userEditingId = uid;
					const adminUser = JSON.parse(sessionStorage.getItem("adminUser"));
					const isSuperAdmin = adminUser && adminUser.role === "superadmin";

					// Populate fields
					document.getElementById("editCompany").value = user.company || "";

					// Format Date for display
					const dateVal = user.createdAt
						? user.createdAt.toDate().toLocaleDateString() +
							" " +
							user.createdAt.toDate().toLocaleTimeString()
						: "N/A";
					document.getElementById("editCreatedAt").value = dateVal;

					document.getElementById("editDisplayName").value =
						user.displayName || "";
					document.getElementById("editEmail").value = user.email || "";
					document.getElementById("editPosition").value = user.position || "";
					document.getElementById("editStatus").value =
						user.status || "unverified";

					// Handle Role Field
					const roleWrapper = document.getElementById("editRoleWrapper");
					if (isSuperAdmin) {
						roleWrapper.style.display = "block";
						document.getElementById("editRole").value = user.role || "user";
					} else {
						roleWrapper.style.display = "none";
					}

					editUserModal.style.display = "flex";
				};

				// Initiate Save (Show Confirm)
				window.initiateSaveUser = function (e) {
					e.preventDefault();
					saveUserConfirmModal.style.display = "flex";
				};

				// Execute Save
				window.confirmSaveUser = async function () {
					if (!userEditingId) return;

					const originalBtnText = confirmSaveYesBtn.textContent;
					confirmSaveYesBtn.textContent = "Saving...";
					confirmSaveYesBtn.disabled = true;

					const adminUser = JSON.parse(sessionStorage.getItem("adminUser"));
					const isSuperAdmin = adminUser && adminUser.role === "superadmin";

					const updates = {
						company: document.getElementById("editCompany").value,
						displayName: document.getElementById("editDisplayName").value,
						position: document.getElementById("editPosition").value,
						status: document.getElementById("editStatus").value,
					};

					// Only update role if Superadmin
					if (isSuperAdmin) {
						updates.role = document.getElementById("editRole").value;
					}

					try {
						await db.collection("users").doc(userEditingId).update(updates);
						alert(translations[currentLang].actionSuccess);
						saveUserConfirmModal.style.display = "none";
						editUserModal.style.display = "none";
					} catch (error) {
						console.error("Error updating user:", error);
						alert(translations[currentLang].actionError + " " + error.message);
						saveUserConfirmModal.style.display = "none";
					} finally {
						confirmSaveYesBtn.textContent = originalBtnText;
						confirmSaveYesBtn.disabled = false;
						userEditingId = null;
					}
				};

				// --- OBSERVATIONS DASHBOARD ---
				function updateObservationsDashboard() {
					const startDate = startDateInput.value;
					const endDate = endDateInput.value;
					let filteredReports = allReports;

					if (startDate && endDate) {
						filteredReports = allReports.filter((report) => {
							if (!report.obsDate) return false;
							return report.obsDate >= startDate && report.obsDate <= endDate;
						});
					}
					renderObservationsTable(filteredReports);
					updatePieChart(
						filteredReports,
						"observerPosition",
						"positionChart",
						"positionLegend",
						translations[currentLang].chartTitlePosition,
						positionChart,
						(c) => (positionChart = c),
					);
					updateCategoryCharts(filteredReports);
					updatePieChart(
						filteredReports,
						"obsType",
						"typeChart",
						"typeLegend",
						translations[currentLang].chartTitleType,
						typeChart,
						(c) => (typeChart = c),
					);
				}

				function renderObservationsTable(reports) {
					if (reports.length === 0) {
						contentDiv.innerHTML = `<tr><td colspan="9" style="text-align: center;">${translations[currentLang].noReports}</td></tr>`;
						return;
					}

					let html = "";
					reports.forEach((report) => {
						const date =
							report.obsDate ||
							(report.submittedAt
								? report.submittedAt.toDate().toLocaleDateString()
								: "N/A");

						const time = report.submittedAt
							? report.submittedAt.toDate().toLocaleTimeString([], {
									hour: "2-digit",
									minute: "2-digit",
								})
							: "N/A";

						const photoHtml = report.photoURL
							? `<img src="${report.photoURL}" alt="Observation" class="table-img" onclick="window.open('${report.photoURL}', '_blank')">`
							: "No Image";

						html += `
                        <tr>
                            <td>${report.observerName || "N/A"}</td>
                            <td>${report.observerPosition || "N/A"}</td>
                            <td>${report.obsLocation || "N/A"}</td>
                            <td>${date}</td>
                            <td>${time}</td>
                            <td>${report.obsType || "N/A"}</td>
                            <td class="col-desc">${report.description || "N/A"}</td>
                            <td>${report.category || "N/A"}</td>
                            <td>${photoHtml}</td>
                            <td><button class="details-btn" data-id="${
															report.id
														}">${translations[currentLang].detailsButton}</button></td>
                        </tr>`;
					});

					contentDiv.innerHTML = html;
				}

				function generateColors(numColors) {
					const colors = [];
					const hueStep = 360 / numColors;

					for (let i = 0; i < numColors; i++) {
						const hue = i * hueStep;

						// HSL to HEX conversion (S=70%, L=60%)
						const s = 70 / 100;
						const l = 60 / 100;
						const k = (n) => (n + hue / 30) % 12;
						const a = s * Math.min(l, 1 - l);
						const f = (n) =>
							l - a * Math.max(-1, Math.min(k(n) - 3, Math.min(9 - k(n), 1)));

						const toHex = (x) => {
							const hex = Math.round(x * 255).toString(16);
							return hex.length === 1 ? "0" + hex : hex;
						};

						colors.push(`#${toHex(f(0))}${toHex(f(8))}${toHex(f(4))}`);
					}

					return colors;
				}

				const hraCategories = [
					"Working from Heights",
					"Lifting Operations",
					"Mobile Equipment",
					"Ground Disturbance",
					"Driving & Off-Road Vehicles",
					"Material Handling",
					"Energy Isolation",
					"Confined Spaces",
					"Electrical",
					"Noise",
					"Thermal Stress",
					"Hazardous Materials",
					"Other",
				];

				function updateCategoryCharts(reports) {
					const counts = reports.reduce((acc, report) => {
						const key = report.category || "Unknown";
						acc[key] = (acc[key] || 0) + 1;
						return acc;
					}, {});

					const hraData = {};
					const nonHraData = {};

					Object.keys(counts).forEach((key) => {
						if (hraCategories.includes(key)) {
							hraData[key] = counts[key];
						} else {
							nonHraData[key] = counts[key];
						}
					});

					updateBarChart(
						hraData,
						"hraChart",
						translations[currentLang].hraTitle || "HRA Categories",
						hraChart,
						(c) => (hraChart = c),
						"#e74c3c",
					);

					updateBarChart(
						nonHraData,
						"nonHraChart",
						translations[currentLang].nonHraTitle || "Non-HRA Categories",
						nonHraChart,
						(c) => (nonHraChart = c),
						"#2ecc71",
					);
				}

				function updateBarChart(
					dataObj,
					canvasId,
					title,
					chartInstance,
					setChartInstance,
					color,
				) {
					if (chartInstance) chartInstance.destroy();

					const labels = Object.keys(dataObj);
					const data = Object.values(dataObj);
					const maxDataValue = data.length > 0 ? Math.max(...data) : 0;

					const newChart = new Chart(document.getElementById(canvasId), {
						type: "bar",
						data: {
							labels: labels.map((l) => {
								return (
									translations[currentLang][`cat${l.replace(/\s/g, "")}`] ||
									translations[currentLang][l.replace(/\s/g, "")] ||
									l
								);
							}),
							datasets: [
								{
									label: "Observations",
									data: data,
									backgroundColor: color,
									borderRadius: 4,
									maxBarThickness: 50,
								},
							],
						},
						options: {
							responsive: true,
							maintainAspectRatio: false,
							layout: {
								padding: {
									bottom: 40,
								},
							},
							plugins: {
								legend: { display: false },
								title: { display: true, text: title },
								tooltip: {
									callbacks: {
										label: function (context) {
											return `${context.raw} Observations`;
										},
									},
								},
							},
							scales: {
								y: {
									beginAtZero: true,
									suggestedMax: maxDataValue + 1,
									ticks: {
										stepSize: 1,
										font: { weight: "bold", size: 13 },
									},
									grid: {
										color: "rgba(0, 0, 0, 0.15)",
										lineWidth: 1,
									},
								},
								x: {
									ticks: {
										autoSkip: false,
										maxRotation: 60,
										minRotation: 60,
										font: { size: 11 },
									},
								},
							},
						},
					});
					setChartInstance(newChart);
				}

				function updatePieChart(
					reports,
					field,
					canvasId,
					legendId,
					title,
					chartInstance,
					setChartInstance,
				) {
					const totalObservations = reports.length;
					const counts = reports.reduce((acc, report) => {
						const key = report[field] || "Unknown";
						acc[key] = (acc[key] || 0) + 1;
						return acc;
					}, {});

					if (chartInstance) {
						chartInstance.destroy();
					}

					const centerTextPlugin = {
						id: "centerText",
						beforeDraw: function (chart) {
							if (chart.config.options.plugins.centerText.display) {
								const ctx = chart.ctx;
								const centerConfig = chart.config.options.plugins.centerText;
								const fontWeight = centerConfig.fontWeight || "normal";
								const fontStyle = centerConfig.fontStyle || "Arial";
								const txt = centerConfig.text;
								const color = centerConfig.color || "#000";
								const maxFontSize = centerConfig.maxFontSize || 75;
								const minFontSize = centerConfig.minFontSize || 20;

								ctx.save();
								let fontSize = chart.innerRadius / 1.2; // Aggressive font sizing
								if (fontSize > maxFontSize) fontSize = maxFontSize;
								if (fontSize < minFontSize) fontSize = minFontSize;

								ctx.font = `${fontWeight} ${fontSize}px ${fontStyle}`;
								ctx.textBaseline = "middle";
								ctx.textAlign = "center";

								const textX = Math.round(
									(chart.chartArea.left + chart.chartArea.right) / 2,
								);
								const textY = Math.round(
									(chart.chartArea.top + chart.chartArea.bottom) / 2,
								);

								ctx.fillStyle = color;
								ctx.fillText(txt, textX, textY);
								ctx.restore();
							}
						},
					};

					const newChart = new Chart(document.getElementById(canvasId), {
						type: "doughnut",
						data: {
							labels: Object.keys(counts),
							datasets: [
								{
									data: Object.values(counts),
									backgroundColor: generateColors(Object.keys(counts).length),
								},
							],
						},
						plugins: [centerTextPlugin],
						options: {
							responsive: true,
							maintainAspectRatio: false,
							plugins: {
								legend: {
									display: false,
								},
								title: { display: true, text: title },
								centerText: {
									display: true,
									text: totalObservations,
									color: "#2c3e50",
									fontWeight: "bold", // Corrected property
									fontStyle: "Arial",
									maxFontSize: 70,
									minFontSize: 30,
								},
							},
						},
					});
					setChartInstance(newChart);

					// Generate Custom HTML Legend
					const legendContainer = document.getElementById(legendId);
					if (legendContainer) {
						legendContainer.innerHTML = "";

						const labels = Object.keys(counts);
						const values = Object.values(counts);
						const colors = newChart.data.datasets[0].backgroundColor;

						labels.forEach((label, i) => {
							const translatedLabel =
								translations[currentLang][`cat${label.replace(/\s/g, "")}`] ||
								translations[currentLang][label.replace(/\s/g, "")] ||
								label;

							const item = document.createElement("div");
							item.className = "legend-item";
							item.onclick = () => {
								const meta = newChart.getDatasetMeta(0);
								// Toggle visibility
								meta.data[i].hidden = !meta.data[i].hidden;
								newChart.update();
								// Toggle styling
								item.classList.toggle("hidden");
							};

							const colorBox = document.createElement("div");
							colorBox.className = "legend-color";
							colorBox.style.backgroundColor = colors[i];

							const text = document.createElement("span");
							text.textContent = `${translatedLabel}: ${values[i]}`;

							item.appendChild(colorBox);
							item.appendChild(text);
							legendContainer.appendChild(item);
						});
					}
				} // --- DATA FETCHING ---
				db.collection("observations")
					.orderBy("obsDate", "desc")
					.onSnapshot(
						(snapshot) => {
							loadingDiv.style.display = "none";
							allReports = snapshot.docs.map((doc) => ({
								id: doc.id,
								...doc.data(),
							}));
							// Sort by submittedAt desc, fallback to obsDate desc
							allReports.sort((a, b) => {
								const dateA = a.submittedAt
									? a.submittedAt.toDate()
									: new Date(a.obsDate);
								const dateB = b.submittedAt
									? b.submittedAt.toDate()
									: new Date(b.obsDate);
								return dateB - dateA;
							});
							if (currentView === "observations") applyTranslation(currentLang);
						},
						(error) => {
							console.error("Error fetching observations: ", error);
							loadingDiv.textContent = "Error loading data.";
						},
					);

				db.collection("users")
					.where("status", "in", ["approved", "pending", "unverified"])
					.orderBy("createdAt", "desc")
					.onSnapshot(
						(snapshot) => {
							loadingUsersDiv.style.display = "none";
							allUsers = snapshot.docs.map((doc) => ({
								uid: doc.id,
								...doc.data(),
							}));
							if (currentView === "users") applyTranslation(currentLang);
						},
						(error) => {
							console.error("Error fetching users: ", error);
							loadingUsersDiv.textContent = "Error loading users.";
						},
					);

				// --- EVENT LISTENERS ---
				langButtons.forEach((button) =>
					button.addEventListener("click", function () {
						applyTranslation(this.dataset.lang);
					}),
				);
				tabButtons.forEach((button) =>
					button.addEventListener("click", function () {
						switchView(this.dataset.tab);
					}),
				);
				document.getElementById("logout-btn").addEventListener("click", () => {
					sessionStorage.removeItem("adminUser");
					window.location.href = "admin-login.html";
				});
				applyDateFilterBtn.addEventListener(
					"click",
					updateObservationsDashboard,
				);
				document.getElementById("todayDateFilter").addEventListener("click", () => {
					const today = getLocalToday();
					startDateInput.value = today;
					endDateInput.value = today;
					updateObservationsDashboard();
				});
				resetDateFilterBtn.addEventListener("click", () => {
					startDateInput.value = "";
					endDateInput.value = "";
					updateObservationsDashboard();
				});

				usersTableBody.addEventListener("click", async (e) => {
					// Handle Approve Button
					if (e.target && e.target.classList.contains("approve-btn")) {
						const button = e.target;
						const uid = button.dataset.uid;
						button.disabled = true;
						try {
							await db
								.collection("users")
								.doc(uid)
								.update({ status: "approved" });
						} catch (error) {
							console.error("Error approving user: ", error);
							button.disabled = false;
							alert(
								`${translations[currentLang].actionError}: ${error.message}`,
							);
						}
					}
					// Handle Edit Button
					if (e.target && e.target.classList.contains("edit-user-btn")) {
						const uid = e.target.dataset.uid;
						openEditUserModal(uid);
					}
				});

				contentDiv.addEventListener("click", (e) => {
					if (e.target && e.target.classList.contains("details-btn")) {
						const reportId = e.target.dataset.id;
						const report = allReports.find((r) => r.id === reportId);
						if (report) showDetailsModal(report);
					}
				});

				closeModalBtn.onclick = () => (modal.style.display = "none");

				window.onclick = (event) => {
					if (event.target == modal) modal.style.display = "none";
				};

				function showDetailsModal(report) {
					const date =
						report.obsDate ||
						(report.submittedAt
							? report.submittedAt.toDate().toLocaleDateString()
							: "N/A");
					let photoContent = `<p><strong data-key="modalPhoto">Photo:</strong> ${translations[currentLang].modalNoPhoto}</p>`;
					if (report.photoURL) {
						photoContent = `
							<p><strong data-key="modalPhoto">Photo:</strong></p>
							<div class="modal-photo-container">
								<img src="${report.photoURL}" alt="Observation Photo" class="modal-photo">
							</div>
						`;
					}
					modalBody.innerHTML = `
						<h2>${translations[currentLang].modalTitle}</h2>
						<p><strong>${translations[currentLang].modalDate}:</strong> ${date}</p>
						<p><strong>${translations[currentLang].modalObserver}:</strong> ${
							report.observerName || "N/A"
						}</p>
						<p><strong>${translations[currentLang].modalCompany}:</strong> ${
							report.observerCompany || "N/A"
						}</p>
						<p><strong>${translations[currentLang].modalPosition}:</strong> ${
							report.observerPosition || "N/A"
						}</p>
						<p><strong><span data-key="roomAreaLabel">Room/Area:</span></strong> ${
							report.roomArea || "N/A"
						}</p>
						<p><strong>${translations[currentLang].modalLocation}:</strong> ${
							report.obsLocation || "N/A"
						}</p>
						<p><strong><span data-key="modalPhaseOfConstruction">Phase of Construction</span>:</strong> ${
							report.phaseOfConstruction || "N/A"
						}</p>
						<h3>${translations[currentLang].modalHeaderObservation}</h3>
						<p><strong>${translations[currentLang].modalCategory}:</strong> ${
							report.category || "N/A"
						}</p>
						<p><strong>${translations[currentLang].modalType}:</strong> ${
							report.obsType || "N/A"
						}</p>
						<p><strong>${translations[currentLang].modalDescription}:</strong> ${
							report.description || "N/A"
						}</p>
						<h3>${translations[currentLang].modalHeaderFollowUp}</h3>
						<p><strong>${translations[currentLang].modalImmediateAction}:</strong> ${
							report.immediateAction || "N/A"
						}</p>
						<p><strong>${translations[currentLang].modalRecommendation}:</strong> ${
							report.recommendation || "N/A"
						}</p>
						${photoContent}`;
					modal.style.display = "flex";
				}

				// --- INITIAL LOAD ---
				setDateFiltersMaxDate();
				applyTranslation(currentLang);
				observationFormBtn.addEventListener("click", () => {
					window.location.href = "index.html";
				});

				// --- PDF EXPORT LOGIC ---
				document
					.getElementById("exportPdfBtn")
					.addEventListener("click", exportToPDF);
				
				document
					.getElementById("exportCsvBtn")
					.addEventListener("click", exportToCSV);

				function exportToCSV() {
					const btn = document.getElementById("exportCsvBtn");
					const originalText = btn.textContent;
					btn.textContent = "Exporting...";
					btn.disabled = true;

					try {
						// Filter Logic
						let reportsToExport = allReports;
						if (startDateInput.value && endDateInput.value) {
							reportsToExport = allReports.filter((report) => {
								if (!report.obsDate) return false;
								return (
									report.obsDate >= startDateInput.value &&
									report.obsDate <= endDateInput.value
								);
							});
						}

						const headers = [
							"CS \\ ID", "CS \\ Project", "Project Category", "Room/Area", "Prepared On", 
							"Comments", "General Contractors", "Lease Providers", "Observation Category", 
							"Observation Description", "CS \\ Responsible Party", "Interim Corrective Actions", 
							"Final Corrective Actions", "Category Type", "CS \\ Phase of Contruction", 
							"Notification Date", "High Risk + Significant Exposure", "General Category", 
							"Worst Potential Severity", "CS1 \\ Person Notified", "Record Type", 
							"Created On", "Attachments", "ID", "Link to Records \\ ", 
							"Link to Event records for reports", "Responsible Party USER", "AKA MS", 
							"Country", "Metro", "Region", "Person Notified users", 
							"Privacy Data Notice for Rules \\ ", "Microsoft Data Privacy Notice", 
							"Trail \\ ", "Created by"
						];

						// Helper to escape CSV fields
						const escapeCsv = (str) => {
							if (str === null || str === undefined) return "";
							const stringValue = String(str);
							// If contains comma, quote, or newline, wrap in quotes and escape internal quotes
							if (stringValue.includes(",") || stringValue.includes("\"") || stringValue.includes("\n")) {
								return `"${stringValue.replace(/"/g, '""')}"`;
							}
							return stringValue;
						};

						const formatDate = (dateString, includeTime = false) => {
							 if (!dateString) return "";
							 // Handle YYYY-MM-DD
							 const parts = dateString.split("-");
							 if (parts.length === 3) {
								const date = new Date(parts[0], parts[1] - 1, parts[2]);
								const months = ["Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec"];
								const m = months[date.getMonth()];
								const d = String(date.getDate()).padStart(2, '0');
								const y = date.getFullYear();
								
								if (includeTime) {
									return `${m}-${d}-${y} 00:00`;
								}
								return `${m}-${d}-${y}`;
							 }
							 return dateString;
						};
						
						// Format today's date for "Created On"
						const today = new Date();
						const months = ["Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec"];
						const createdOnStr = `${months[today.getMonth()]}-${String(today.getDate()).padStart(2, '0')}-${today.getFullYear()}`;

						const csvContent = [
							headers.join(","),
							...reportsToExport.map(report => {
								const isHRA = hraCategories.includes(report.category);
								
								const preparedOn = formatDate(report.obsDate, true);
								const categoryType = isHRA ? "HRA (High-Risk Activity)" : "General Category";
								const highRisk = isHRA ? report.category : "";
								const generalCategory = !isHRA ? report.category : "";
								const worstSeverity = isHRA ? "Major (1 Day)" : "Minor (7 Days)";

								return [
									 "", // CS \ ID
									 "", // CS \ Project
									 "", // Project Category
									 escapeCsv(report.roomArea), // Room/Area
									 escapeCsv(preparedOn), // Prepared On
									 "JKT09", // Comments
									 "Jaya Obayashi", // General Contractors
									 "", // Lease Providers
									 escapeCsv(report.obsType), // Observation Category
									 escapeCsv(report.description), // Observation Description
									 "", // CS \ Responsible Party
									 "", // Interim Corrective Actions
									 escapeCsv(report.immediateAction), // Final Corrective Actions
									 escapeCsv(categoryType), // Category Type
									 escapeCsv(report.phaseOfConstruction || "Steel Erection"), // CS \ Phase of Contruction
									 "", // Notification Date
									 escapeCsv(highRisk), // High Risk + Significant Exposure
									 escapeCsv(generalCategory), // General Category
									 escapeCsv(worstSeverity), // Worst Potential Severity
									 "", // CS1 \ Person Notified
									 "", // Record Type
									 escapeCsv(createdOnStr), // Created On
									 "", // Attachments
									 "", // ID
									 "", // Link to Records \ 
									 "", // Link to Event records for reports
									 "", // Responsible Party USER
									 "", // AKA MS
									 "Indonesia", // Country
									 "Jakarta JKT", // Metro
									 "APAC", // Region
									 "", // Person Notified users
									 "", // Privacy Data Notice for Rules \ 
									 "", // Microsoft Data Privacy Notice
									 "", // Trail \ 
									 "EHS Form" // Created by
								].join(",");
							})
						].join("\n");

						const blob = new Blob([csvContent], { type: "text/csv;charset=utf-8;" });
						const link = document.createElement("a");
						const url = URL.createObjectURL(blob);
						link.setAttribute("href", url);
						link.setAttribute("download", `Observation_Report_${new Date().toISOString().slice(0, 10)}.csv`);
						link.style.visibility = 'hidden';
						document.body.appendChild(link);
						link.click();
						document.body.removeChild(link);

					} catch (error) {
						console.error("Export CSV failed:", error);
						alert("Failed to export CSV.");
					} finally {
						btn.textContent = originalText;
						btn.disabled = false;
					}
				}

				async function exportToPDF() {
					const btn = document.getElementById("exportPdfBtn");
					const originalText = btn.textContent;
					btn.textContent = "Processing Images...";
					btn.disabled = true;

					try {
						const { jsPDF } = window.jspdf;
						const doc = new jsPDF("l", "mm", "a4"); // Landscape
						const pageWidth = doc.internal.pageSize.getWidth();
						const pageHeight = doc.internal.pageSize.getHeight();
						const margin = 14;

						const startDate = startDateInput.value || "All Time";
						const endDate = endDateInput.value || "All Time";
						const timestamp = new Date().toLocaleString();

						// --- HELPER: HEADER & FOOTER ---
						const addHeaderFooter = (data) => {
							// Header
							doc.setFontSize(16);
							doc.setFont("helvetica", "bold");
							doc.text("JKT 09 GOLDEN HOURS OBSERVATION", pageWidth / 2, 15, {
								align: "center",
							});

							doc.setFontSize(10);
							doc.setFont("helvetica", "normal");
							doc.text(
								`Period: ${startDate} to ${endDate}`,
								pageWidth / 2,
								21,
								{ align: "center" },
							);

							// Footer
							doc.setFontSize(8);
							doc.setFont("helvetica", "normal");
							const pageCount = doc.internal.getNumberOfPages();
							const adminEmail = adminUser
								? adminUser.email || "Admin"
								: "System";
							doc.text(
								`Exported at: ${timestamp} | By: ${adminEmail}`,
								margin,
								pageHeight - 10,
							);
							doc.text(
								`Page ${pageCount}`,
								pageWidth - margin,
								pageHeight - 10,
								{ align: "right" },
							);
						};

						// --- HELPER: FETCH IMAGE AS BASE64 ---
						const getBase64ImageFromUrl = async (imageUrl) => {
							try {
								const res = await fetch(imageUrl);
								const blob = await res.blob();
								return new Promise((resolve, reject) => {
									const reader = new FileReader();
									reader.onloadend = () => resolve(reader.result);
									reader.onerror = reject;
									reader.readAsDataURL(blob);
								});
							} catch (error) {
								console.error("Error converting image:", error);
								return null;
							}
						};

						// --- PAGE 1: CHARTS ---
						addHeaderFooter();

						const startY = 30;
						const chartGap = 10;
						const availableWidth = pageWidth - (margin * 2);
						const colWidth = (availableWidth - chartGap) / 2;

						// Define layout areas
						// Top Left: HRA Bar Chart
						// Top Right: Non-HRA Bar Chart
						// Bottom Left: Position Pie Chart
						// Bottom Right: Type Pie Chart

						const drawChart = (chart, title, x, y, width, height) => {
							if (!chart) return;

							// Title
							doc.setFontSize(10);
							doc.setFont("helvetica", "bold");
							doc.text(title, x, y);

							// Chart Image
							const imgData = chart.toBase64Image();
							// Add some spacing below title
							const imgY = y + 2; 
							
							// For pie charts, we need to handle the custom legend manually drawn
							doc.addImage(imgData, "PNG", x, imgY, width, height);

							return imgY + height;
						};

						const drawLegend = (chart, x, y, width) => {
							if (!chart || chart.config.type === 'bar') return 0;
							
							const labels = chart.data.labels;
							const dataValues = chart.data.datasets[0].data;
							const colors = chart.data.datasets[0].backgroundColor;
							
							doc.setFontSize(8);
							doc.setFont("helvetica", "normal");
							
							let legendY = y;
							const boxSize = 3;
							
							labels.forEach((label, idx) => {
								if (dataValues[idx] === 0) return;
								
								const translatedLabel =
									translations[currentLang][`cat${label.replace(/\s/g, "")}`] ||
									translations[currentLang][label.replace(/\s/g, "")] ||
									label;
								const text = `${translatedLabel}: ${dataValues[idx]}`;
								
								doc.setFillColor(colors[idx]);
								doc.rect(x, legendY - boxSize, boxSize, boxSize, "F");
								doc.text(text, x + 5, legendY);
								
								legendY += 4;
							});
							return legendY - y;
						};

						// --- ROW 1: BAR CHARTS ---
						const row1Y = startY;
						const barHeight = 60; // Increased height for bar charts
						
						// HRA Chart (Top Left)
						if (hraChart) {
							drawChart(
								hraChart, 
								translations[currentLang].hraTitle || "HRA", 
								margin, 
								row1Y, 
								colWidth, 
								barHeight
							);
						}

						// Non-HRA Chart (Top Right)
						if (nonHraChart) {
							drawChart(
								nonHraChart, 
								translations[currentLang].nonHraTitle || "Non-HRA", 
								margin + colWidth + chartGap, 
								row1Y, 
								colWidth, 
								barHeight
							);
						}

						// --- ROW 2: PIE CHARTS ---
						const row2Y = row1Y + barHeight + 15;
						const pieDiameter = 45; 
						const legendWidth = 60;
						
						// Position Chart (Bottom Left)
						if (positionChart) {
							drawChart(
								positionChart, 
								translations[currentLang].chartTitlePosition, 
								margin, 
								row2Y, 
								pieDiameter, 
								pieDiameter
							);
							// Draw Legend next to pie
							drawLegend(
								positionChart, 
								margin + pieDiameter + 5, 
								row2Y + 5, 
								legendWidth
							);
						}

						// Type Chart (Bottom Right) - Positioned under Non-HRA chart
						if (typeChart) {
							drawChart(
								typeChart, 
								translations[currentLang].chartTitleType, 
								margin + colWidth + chartGap, 
								row2Y, 
								pieDiameter, 
								pieDiameter
							);
							// Draw Legend next to pie
							drawLegend(
								typeChart, 
								margin + colWidth + chartGap + pieDiameter + 5, 
								row2Y + 5, 
								legendWidth
							);
						}

						// --- PAGE 2+: TABLE ---
						doc.addPage(); // Start table on new page

						const tableHead = [
							[
								"No",
								"Date",
								"Time",
								"Observer Name",
								"Role",
								"Room/Area",
								"Location",
								"Type",
								"Description",
								"Category",
								"Image",
							],
						];

						// Filter Logic
						let reportsToExport = allReports;
						if (startDateInput.value && endDateInput.value) {
							reportsToExport = allReports.filter((report) => {
								if (!report.obsDate) return false;
								return (
									report.obsDate >= startDateInput.value &&
									report.obsDate <= endDateInput.value
								);
							});
						}

						// Pre-process body data (Fetch images)
						const tableBody = await Promise.all(
							reportsToExport.map(async (report, index) => {
								const date =
									report.obsDate ||
									(report.submittedAt
										? report.submittedAt.toDate().toLocaleDateString()
										: "N/A");

								const time = report.submittedAt
									? report.submittedAt.toDate().toLocaleTimeString([], {
											hour: "2-digit",
											minute: "2-digit",
										})
									: "N/A";

								let imageBase64 = null;
								if (report.photoURL) {
									imageBase64 = await getBase64ImageFromUrl(report.photoURL);
								}

								return [
									index + 1, // Row Number
									date,
									time,
									report.observerName || "N/A",
									report.observerPosition || "N/A",
									report.roomArea || "N/A",
									report.obsLocation || "N/A",
									report.obsType || "N/A",
									report.description || "N/A",
									report.category || "N/A",
									imageBase64, // This will be the Base64 string or null
								];
							}),
						);

						doc.autoTable({
							head: tableHead,
							body: tableBody,
							startY: 25,
							margin: { top: 25, bottom: 15, left: margin, right: margin },
							styles: { fontSize: 8, cellPadding: 2, valign: "middle" },
							columnStyles: {
								0: { cellWidth: 8 }, // No
								1: { cellWidth: 18 }, // Date
								2: { cellWidth: 12 }, // Time
								5: { cellWidth: 20 }, // Room/Area
								8: { cellWidth: 40 }, // Description
								10: { cellWidth: 20 }, // Image column width
							},
							bodyStyles: { minCellHeight: 15 }, // Smaller row height
							rowPageBreak: "avoid", // Avoid splitting rows
							didDrawPage: function (data) {
								addHeaderFooter();
							},
							didParseCell: function (data) {
								// Check Image Column (Index 10)
								if (data.section === "body" && data.column.index === 10) {
									if (data.cell.raw) {
										// Has image data -> Clear text to prevent dump
										data.cell.text = "";
									} else {
										// No image data -> Show "No Image" text
										data.cell.text = "No Image";
									}
								}
							},
							didDrawCell: function (data) {
								// Draw Image in the Image Column (Index 10)
								if (
									data.section === "body" &&
									data.column.index === 10 &&
									data.cell.raw
								) {
									const imgData = data.cell.raw; // This is the Base64 string
									if (imgData) {
										const dim = 12; // Smaller Image dimension (12mm)
										// Center image in cell
										const x = data.cell.x + (data.cell.width - dim) / 2;
										const y = data.cell.y + (data.cell.height - dim) / 2;
										try {
											doc.addImage(imgData, x, y, dim, dim);
										} catch (e) {
											console.warn("Failed to draw image", e);
										}
									}
								}
							},
						});

						doc.save(
							`Observation_Report_${new Date().toISOString().slice(0, 10)}.pdf`,
						);
					} catch (error) {
						console.error("Export failed:", error);
						alert("Failed to export PDF. Check console for details.");
					} finally {
						btn.textContent = originalText;
						btn.disabled = false;
					}
				}
			});
		</script>
	</body>
</html>
